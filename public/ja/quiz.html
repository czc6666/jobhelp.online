<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚­ãƒ£ãƒªã‚¢ãƒ†ã‚¹ãƒˆ - ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ³ãƒ‘ã‚¹</title>
    <meta name="description" content="ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªã‚­ãƒ£ãƒªã‚¢ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚ä¸€é€£ã®è³ªå•ã«ç­”ãˆã¦ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸAIã‚­ãƒ£ãƒªã‚¢åˆ†æã‚’å—ã‘å–ã‚‹ã‹ã€ç›´æ¥ã‚ãªãŸã®çŠ¶æ³ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚">
    <meta name="robots" content="noindex, follow">
    <link rel="canonical" href="https://jobhelp.online/ja/quiz.html">
    <link rel="alternate" hreflang="zh" href="https://jobhelp.online/quiz.html">
    <link rel="alternate" hreflang="en" href="https://jobhelp.online/en/quiz.html">
    <link rel="alternate" hreflang="es" href="https://jobhelp.online/es/quiz.html">
    <link rel="alternate" hreflang="de" href="https://jobhelp.online/de/quiz.html">
    <link rel="alternate" hreflang="fr" href="https://jobhelp.online/fr/quiz.html">
    <link rel="alternate" hreflang="ja" href="https://jobhelp.online/ja/quiz.html">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link rel="stylesheet" href="../styles.css">
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <header class="bg-white shadow-md w-full">
        <nav class="container mx-auto px-6 py-4">
            <a href="index.html" class="text-xl font-bold text-gray-800">ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ³ãƒ‘ã‚¹</a>
        </nav>
    </header>

    <main id="quiz-container" class="container mx-auto p-6 flex-grow flex flex-col justify-center">
        <!-- Quiz content will be injected here -->
    </main>

    <div id="chat-container" class="container mx-auto p-6 flex-grow flex-col justify-center" style="display: none;">
        <div id="chat-box" class="flex-grow bg-white p-4 rounded-lg shadow-inner overflow-y-auto mb-4 h-96">
            <!-- Chat messages will appear here -->
        </div>
        <div class="flex">
            <input type="text" id="chat-input" class="flex-grow border rounded-l-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ãƒ¬ãƒãƒ¼ãƒˆã«ã¤ã„ã¦è³ªå•ã™ã‚‹...">
            <button id="chat-submit" class="bg-blue-600 text-white px-4 rounded-r-lg hover:bg-blue-700 disabled:bg-blue-300">é€ä¿¡</button>
        </div>
    </div>
    
    <footer class="bg-white mt-auto w-full">
        <div class="container mx-auto px-6 py-4 text-center text-gray-600">
            <p>&copy; 2025 ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ³ãƒ‘ã‚¹. All rights reserved.</p>
        </div>
    </footer>

    <script>
        const quizContainer = document.getElementById('quiz-container');
        const chatContainer = document.getElementById('chat-container');
        const chatBox = document.getElementById('chat-box');
        const chatInput = document.getElementById('chat-input');
        const chatSubmit = document.getElementById('chat-submit');
        const converter = new showdown.Converter({simplifiedAutoLink: true, openLinksInNewWindow: true, strikethrough: true});
        
        let turnstileToken = null;
        let turnstileRetries = 0;
        const MAX_RETRIES = 3;

        const questions = [
            "æ¬¡ã®ä»•äº‹ã§æœ€ã‚‚å¾—ãŸã„ã‚‚ã®ã¯ä½•ã§ã™ã‹ï¼Ÿ",
            "ã©ã®ã‚ˆã†ãªè·å ´ç’°å¢ƒã§æœ€ã‚‚ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’æ„Ÿã˜ã€ç†±ä¸­ã§ãã¾ã™ã‹ï¼Ÿ",
            "æ™‚é–“ã‚’å¿˜ã‚Œã‚‹ã»ã©å¤¢ä¸­ã«ãªã£ãŸä»•äº‹ã‚„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚",
            "ã‚‚ã—ãŠé‡‘ã®å¿ƒé…ãŒãªã‹ã£ãŸã‚‰ã€è‡ªåˆ†ã®æ™‚é–“ã‚’ä½•ã«ä½¿ã„ã¾ã™ã‹ï¼Ÿ",
            "ç†æƒ³çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹ã«ã¤ã„ã¦ã€ã©ã®ã‚ˆã†ã«è€ƒãˆã¾ã™ã‹ï¼Ÿ"
        ];
        let currentQuestionIndex = 0;
        let answers = [];

        function renderQuestion() {
            if (currentQuestionIndex < questions.length) {
                quizContainer.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-2xl mx-auto">
                        <p class="text-2xl font-semibold mb-6">${questions[currentQuestionIndex]}</p>
                        <textarea id="answer-input" class="w-full p-2 border rounded mb-6" rows="4" placeholder="ã‚ãªãŸã®å›ç­”..."></textarea>
                        <button id="next-btn" class="bg-gray-900 text-white px-6 py-3 rounded-lg font-semibold apple-button">æ¬¡ã¸</button>
                        <p class="text-sm text-gray-500 mt-4">${currentQuestionIndex + 1} / ${questions.length}</p>
                    </div>
                `;
                document.getElementById('next-btn').addEventListener('click', handleNext);
            } else {
                showAnalysisOptions();
            }
        }

        function handleNext() {
            const answer = document.getElementById('answer-input').value.trim();
            if (answer) {
                answers.push(`è³ªå• ${currentQuestionIndex + 1}: ${questions[currentQuestionIndex]}\nå›ç­”: ${answer}`);
                currentQuestionIndex++;
                renderQuestion();
            } else {
                alert('å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function showAnalysisOptions() {
            quizContainer.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-4">åˆ†æã®æº–å‚™ãŒã§ãã¾ã—ãŸ</h2>
                    <p class="text-gray-600 mb-6">å›ç­”ã‚’ã„ãŸã ãã¾ã—ãŸã€‚ã‚¯ã‚¤ã‚ºã«åŸºã¥ã„ãŸåˆ†æã®ãŸã‚ã«é€ä¿¡ã™ã‚‹ã‹ã€ã“ã‚Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚­ãƒ£ãƒªã‚¢çŠ¶æ³ã‚’ç›´æ¥èª¬æ˜ã—ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸåˆ†æã‚’å—ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
                    <div class="cf-turnstile" data-sitekey="0x4AAAAAAAcF3d22Nae41Y3g" data-callback="onTurnstileSuccess"></div>
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="submit-quiz" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg apple-button hover:bg-blue-700 disabled:bg-blue-300" disabled>ã‚¯ã‚¤ã‚ºã®å›ç­”ã‚’åˆ†æ</button>
                        <button id="direct-analysis" class="bg-gray-700 text-white font-bold py-3 px-6 rounded-lg apple-button hover:bg-gray-800">ã¾ãŸã¯ã€ç›´æ¥èª¬æ˜ã™ã‚‹</button>
                    </div>
                </div>
            `;
            document.getElementById('submit-quiz').addEventListener('click', () => submitForAnalysis(answers.join('\n\n')));
            document.getElementById('direct-analysis').addEventListener('click', showDirectInput);
        }

        function showDirectInput() {
            quizContainer.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-4">ã‚ãªãŸã®çŠ¶æ³ã‚’èª¬æ˜ã—ã¦ãã ã•ã„</h2>
                    <p class="text-gray-600 mb-6">ã‚ãªãŸã®è·å‹™çµŒæ­´ã€ç¾åœ¨ã®çŠ¶æ³ã€æ‚©ã¿ã€ã¾ãŸã¯ç›®æ¨™ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚è©³ç´°ãŒå¤šã‘ã‚Œã°å¤šã„ã»ã©ã€ã‚ˆã‚Šè‰¯ã„åˆ†æãŒã§ãã¾ã™ã€‚</p>
                    <textarea id="direct-input" class="w-full p-2 border rounded mb-6" rows="8" placeholder="ä¾‹ï¼šç§ã¯5å¹´é–“é–‹ç™ºè€…ã¨ã—ã¦åƒã„ã¦ã„ã¾ã™ãŒã€æ–¹å‘æ€§ã‚’è¦‹å¤±ã£ã¦ã„ã¾ã™..."></textarea>
                    <div class="cf-turnstile" data-sitekey="0x4AAAAAAAcF3d22Nae41Y3g" data-callback="onTurnstileSuccess"></div>
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="submit-direct" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg apple-button hover:bg-blue-700 disabled:bg-blue-300" disabled>ç›´æ¥åˆ†æã‚’ä¾é ¼</button>
                    </div>
                </div>
            `;
            document.getElementById('submit-direct').addEventListener('click', () => {
                const directText = document.getElementById('direct-input').value;
                if (directText.trim()) {
                    submitForAnalysis(directText);
                } else {
                    alert('ã‚ãªãŸã®çŠ¶æ³ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚');
                }
            });
            turnstile.render(quizContainer.querySelector('.cf-turnstile'));
        }

        window.onTurnstileSuccess = function(token) {
            turnstileToken = token;
            document.querySelectorAll('#submit-quiz, #submit-direct').forEach(btn => btn.disabled = false);
        };
        
        async function submitForAnalysis(promptText) {
            if (!turnstileToken && turnstileRetries < MAX_RETRIES) {
                console.log('Turnstile token not ready, retrying...');
                turnstileRetries++;
                turnstile.reset();
                setTimeout(() => submitForAnalysis(promptText), 500);
                return;
            }

            if (!turnstileToken) {
                alert('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                return;
            }

            quizContainer.style.display = 'none';
            chatContainer.style.display = 'flex';
            appendMessage('bot', 'ğŸ¤– å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚­ãƒ£ãƒªã‚¢åˆ†æã‚’æº–å‚™ã—ã¦ã„ã¾ã™...');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: promptText, token: turnstileToken, lang: 'ja' })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botMessageElement = appendMessage('bot', '');
                let accumulatedHtml = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    accumulatedHtml += converter.makeHtml(chunk);
                    botMessageElement.innerHTML = accumulatedHtml;
                    chatBox.scrollTop = chatBox.scrollHeight;
                }

            } catch (error) {
                console.error('Fetch error:', error);
                appendMessage('bot', `ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š ${error.message}`);
            }
        }
        
        function appendMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${sender === 'user' ? 'user-message' : 'bot-message'}`;
            
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            contentElement.innerHTML = text; // Use innerHTML to render markdown
            
            messageElement.appendChild(contentElement);
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
            return contentElement; // Return content element to be updated by stream
        }

        async function handleChatSubmit() {
            const userText = chatInput.value.trim();
            if (!userText) return;

            appendMessage('user', userText);
            chatInput.value = '';
            chatSubmit.disabled = true;

            const fullPrompt = `ã“ã‚Œã¾ã§ã®ä¼šè©±ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™:\n${chatBox.innerText}\n\nç§ã®æ–°ã—ã„è³ªå•ã¯: ${userText}`;
            
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: fullPrompt, lang: 'ja' })
                });

                if (!response.ok) throw new Error("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¿œç­”ãŒæ­£å¸¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botMessageElement = appendMessage('bot', '');
                let accumulatedHtml = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    accumulatedHtml += converter.makeHtml(chunk);
                    botMessageElement.innerHTML = accumulatedHtml;
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } catch (error) {
                console.error('Chat error:', error);
                appendMessage('bot', "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ã”è³ªå•ã‚’å‡¦ç†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
            } finally {
                chatSubmit.disabled = false;
                chatInput.focus();
            }
        }
        
        chatSubmit.addEventListener('click', handleChatSubmit);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleChatSubmit();
        });

        // Initial render
        renderQuestion();
    </script>
</body>
</html> 