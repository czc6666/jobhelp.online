<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>キャリアテスト - キャリアコンパス</title>
    <meta name="description" content="インタラクティブなキャリアテストを開始します。一連の質問に答えて、パーソナライズされたAIキャリア分析を受け取るか、直接あなたの状況を説明してください。">
    <meta name="robots" content="noindex, follow">
    <link rel="canonical" href="https://jobhelp.online/ja/quiz.html">
    <link rel="alternate" hreflang="zh" href="https://jobhelp.online/quiz.html">
    <link rel="alternate" hreflang="en" href="https://jobhelp.online/en/quiz.html">
    <link rel="alternate" hreflang="es" href="https://jobhelp.online/es/quiz.html">
    <link rel="alternate" hreflang="de" href="https://jobhelp.online/de/quiz.html">
    <link rel="alternate" hreflang="fr" href="https://jobhelp.online/fr/quiz.html">
    <link rel="alternate" hreflang="ja" href="https://jobhelp.online/ja/quiz.html">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link rel="stylesheet" href="../styles.css">
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <header class="bg-white shadow-md w-full">
        <nav class="container mx-auto px-6 py-4">
            <a href="index.html" class="text-xl font-bold text-gray-800">キャリアコンパス</a>
        </nav>
    </header>

    <main id="quiz-container" class="container mx-auto p-6 flex-grow flex flex-col justify-center">
        <!-- Quiz content will be injected here -->
    </main>

    <div id="chat-container" class="container mx-auto p-6 flex-grow flex-col justify-center" style="display: none;">
        <div id="chat-box" class="flex-grow bg-white p-4 rounded-lg shadow-inner overflow-y-auto mb-4 h-96">
            <!-- Chat messages will appear here -->
        </div>
        <div class="flex">
            <input type="text" id="chat-input" class="flex-grow border rounded-l-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="レポートについて質問する...">
            <button id="chat-submit" class="bg-blue-600 text-white px-4 rounded-r-lg hover:bg-blue-700 disabled:bg-blue-300">送信</button>
        </div>
    </div>
    
    <footer class="bg-white mt-auto w-full">
        <div class="container mx-auto px-6 py-4 text-center text-gray-600">
            <p>&copy; 2025 キャリアコンパス. All rights reserved.</p>
        </div>
    </footer>

    <script>
        const quizContainer = document.getElementById('quiz-container');
        const chatContainer = document.getElementById('chat-container');
        const chatBox = document.getElementById('chat-box');
        const chatInput = document.getElementById('chat-input');
        const chatSubmit = document.getElementById('chat-submit');
        const converter = new showdown.Converter({simplifiedAutoLink: true, openLinksInNewWindow: true, strikethrough: true});
        
        let turnstileToken = null;
        let turnstileRetries = 0;
        const MAX_RETRIES = 3;

        const questions = [
            "次の仕事で最も得たいものは何ですか？",
            "どのような職場環境で最もエネルギーを感じ、熱中できますか？",
            "時間を忘れるほど夢中になった仕事やプロジェクトについて説明してください。",
            "もしお金の心配がなかったら、自分の時間を何に使いますか？",
            "理想的なワークライフバランスについて、どのように考えますか？"
        ];
        let currentQuestionIndex = 0;
        let answers = [];

        function renderQuestion() {
            if (currentQuestionIndex < questions.length) {
                quizContainer.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-2xl mx-auto">
                        <p class="text-2xl font-semibold mb-6">${questions[currentQuestionIndex]}</p>
                        <textarea id="answer-input" class="w-full p-2 border rounded mb-6" rows="4" placeholder="あなたの回答..."></textarea>
                        <button id="next-btn" class="bg-gray-900 text-white px-6 py-3 rounded-lg font-semibold apple-button">次へ</button>
                        <p class="text-sm text-gray-500 mt-4">${currentQuestionIndex + 1} / ${questions.length}</p>
                    </div>
                `;
                document.getElementById('next-btn').addEventListener('click', handleNext);
            } else {
                showAnalysisOptions();
            }
        }

        function handleNext() {
            const answer = document.getElementById('answer-input').value.trim();
            if (answer) {
                answers.push(`質問 ${currentQuestionIndex + 1}: ${questions[currentQuestionIndex]}\n回答: ${answer}`);
                currentQuestionIndex++;
                renderQuestion();
            } else {
                alert('回答を入力してください。');
            }
        }

        function showAnalysisOptions() {
            quizContainer.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-4">分析の準備ができました</h2>
                    <p class="text-gray-600 mb-6">回答をいただきました。クイズに基づいた分析のために送信するか、これをスキップしてキャリア状況を直接説明し、パーソナライズされた分析を受けることができます。</p>
                    <div class="cf-turnstile" data-sitekey="0x4AAAAAAAcF3d22Nae41Y3g" data-callback="onTurnstileSuccess"></div>
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="submit-quiz" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg apple-button hover:bg-blue-700 disabled:bg-blue-300" disabled>クイズの回答を分析</button>
                        <button id="direct-analysis" class="bg-gray-700 text-white font-bold py-3 px-6 rounded-lg apple-button hover:bg-gray-800">または、直接説明する</button>
                    </div>
                </div>
            `;
            document.getElementById('submit-quiz').addEventListener('click', () => submitForAnalysis(answers.join('\n\n')));
            document.getElementById('direct-analysis').addEventListener('click', showDirectInput);
        }

        function showDirectInput() {
            quizContainer.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-4">あなたの状況を説明してください</h2>
                    <p class="text-gray-600 mb-6">あなたの職務経歴、現在の状況、悩み、または目標について説明してください。詳細が多ければ多いほど、より良い分析ができます。</p>
                    <textarea id="direct-input" class="w-full p-2 border rounded mb-6" rows="8" placeholder="例：私は5年間開発者として働いていますが、方向性を見失っています..."></textarea>
                    <div class="cf-turnstile" data-sitekey="0x4AAAAAAAcF3d22Nae41Y3g" data-callback="onTurnstileSuccess"></div>
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="submit-direct" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg apple-button hover:bg-blue-700 disabled:bg-blue-300" disabled>直接分析を依頼</button>
                    </div>
                </div>
            `;
            document.getElementById('submit-direct').addEventListener('click', () => {
                const directText = document.getElementById('direct-input').value;
                if (directText.trim()) {
                    submitForAnalysis(directText);
                } else {
                    alert('あなたの状況を説明してください。');
                }
            });
            turnstile.render(quizContainer.querySelector('.cf-turnstile'));
        }

        window.onTurnstileSuccess = function(token) {
            turnstileToken = token;
            document.querySelectorAll('#submit-quiz, #submit-direct').forEach(btn => btn.disabled = false);
        };
        
        async function submitForAnalysis(promptText) {
            if (!turnstileToken && turnstileRetries < MAX_RETRIES) {
                console.log('Turnstile token not ready, retrying...');
                turnstileRetries++;
                turnstile.reset();
                setTimeout(() => submitForAnalysis(promptText), 500);
                return;
            }

            if (!turnstileToken) {
                alert('セキュリティ認証に失敗しました。ページを再読み込みして、もう一度お試しください。');
                return;
            }

            quizContainer.style.display = 'none';
            chatContainer.style.display = 'flex';
            appendMessage('bot', '🤖 少々お待ちください。パーソナライズされたキャリア分析を準備しています...');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: promptText, token: turnstileToken, lang: 'ja' })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "分析中にエラーが発生しました。");
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botMessageElement = appendMessage('bot', '');
                let accumulatedHtml = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    accumulatedHtml += converter.makeHtml(chunk);
                    botMessageElement.innerHTML = accumulatedHtml;
                    chatBox.scrollTop = chatBox.scrollHeight;
                }

            } catch (error) {
                console.error('Fetch error:', error);
                appendMessage('bot', `申し訳ありません、エラーが発生しました： ${error.message}`);
            }
        }
        
        function appendMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${sender === 'user' ? 'user-message' : 'bot-message'}`;
            
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            contentElement.innerHTML = text; // Use innerHTML to render markdown
            
            messageElement.appendChild(contentElement);
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
            return contentElement; // Return content element to be updated by stream
        }

        async function handleChatSubmit() {
            const userText = chatInput.value.trim();
            if (!userText) return;

            appendMessage('user', userText);
            chatInput.value = '';
            chatSubmit.disabled = true;

            const fullPrompt = `これまでの会話は次のとおりです:\n${chatBox.innerText}\n\n私の新しい質問は: ${userText}`;
            
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: fullPrompt, lang: 'ja' })
                });

                if (!response.ok) throw new Error("ネットワーク応答が正常ではありませんでした。");

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botMessageElement = appendMessage('bot', '');
                let accumulatedHtml = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    accumulatedHtml += converter.makeHtml(chunk);
                    botMessageElement.innerHTML = accumulatedHtml;
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } catch (error) {
                console.error('Chat error:', error);
                appendMessage('bot', "申し訳ありません、ご質問を処理できませんでした。");
            } finally {
                chatSubmit.disabled = false;
                chatInput.focus();
            }
        }
        
        chatSubmit.addEventListener('click', handleChatSubmit);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleChatSubmit();
        });

        // Initial render
        renderQuestion();
    </script>
</body>
</html> 