<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start Test | Career Compass</title>
    <meta name="description" content="Answer 5 carefully designed questions to instantly get an AI-generated deep career personality analysis report and begin your career exploration journey.">
    <meta name="keywords" content="career test, personality analysis, AI career advisor, career direction, Career Compass, online quiz">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://jobhelp.online/en/quiz.html">

    <!-- Hreflang for SEO -->
    <link rel="alternate" hreflang="zh" href="https://jobhelp.online/quiz.html">
    <link rel="alternate" hreflang="en" href="https://jobhelp.online/en/quiz.html">
    <link rel="alternate" hreflang="es" href="https://jobhelp.online/es/quiz.html">
    <link rel="alternate" hreflang="de" href="https://jobhelp.online/de/quiz.html">
    <link rel="alternate" hreflang="x-default" href="https://jobhelp.online/quiz.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jobhelp.online/en/quiz.html">
    <meta property="og:title" content="Start Test | Career Compass">
    <meta property="og:description" content="Answer 5 carefully designed questions to instantly get an AI-generated deep career personality analysis report.">
    <meta property="og:image" content="https://jobhelp.online/og-image.png">
    <meta property="og:site_name" content="Career Compass">
    <meta property="og:locale" content="en_US">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://jobhelp.online/en/quiz.html">
    <meta name="twitter:title" content="Start Test | Career Compass">
    <meta name="twitter:description" content="Answer 5 carefully designed questions to instantly get an AI-generated deep career personality analysis report.">
    <meta name="twitter:image" content="https://jobhelp.online/og-image.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <!-- Turnstile Script -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onTurnstileLoad" async defer></script>
    <style>
        /* Base styling for smooth transitions */
        .quiz-card, #direct-input-container {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0) scale(1);
            opacity: 1;
            will-change: transform, opacity;
            min-height: 32rem; /* Fix for jittering button */
        }

        /* Animation states */
        .card-enter {
            transform: translateX(100%) scale(0.9);
            opacity: 0;
        }
        .card-exit {
            transform: translateX(-100%) scale(0.9);
            opacity: 0;
        }

        /* For the loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Structured Data (JSON-LD) for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [{
            "@type": "Question",
            "name": "Is this test and analysis free?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Yes, it's completely free. We are committed to helping more people who are confused about their future through AI technology. Some of the models we use are provided with free quotas by platforms like OpenRouter, allowing us to pass this value on to you."
            }
        }, {
            "@type": "Question",
            "name": "Is my data and personal information secure?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "We take your privacy very seriously. Your answers and conversations with the AI are anonymous and are only used for the current analysis and dialogue. We do not store or use them for any other purpose."
            }
        }]
    }
    </script>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="w-full bg-white/80 backdrop-blur-md sticky top-0 z-10 border-b border-gray-200">
        <div class="container mx-auto px-6 py-4 flex items-center justify-between">
            <a href="/en/" class="text-xl font-bold text-gray-900">Career Compass</a>
            <a href="/en/" class="text-sm font-semibold text-gray-600 hover:text-blue-600">
                &larr; Back to Home
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center justify-center p-4">
        <div id="view-container" class="w-full max-w-2xl mx-auto">
            <!-- Quiz Container -->
            <div id="quiz-container">
                <!-- This div will hold the actively transitioning cards -->
            </div>

            <!-- Direct Input Container (hidden by default) -->
            <div id="direct-input-container" class="hidden bg-white rounded-xl shadow-lg p-6 md:p-10">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Talk Directly to the AI Mentor</h2>
                <p class="text-gray-600 mb-6">Enter your concerns, thoughts, or a self-introduction below, and the AI will generate a personalized career planning report for you.</p>
                <textarea id="direct-input-text" rows="8" placeholder="e.g., I'm a junior majoring in marketing, but I feel I'm introverted and don't enjoy socializing. I'm confused about my future and don't know what I can do..." class="w-full border rounded-lg p-3 text-base focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
                <button id="direct-input-submit-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-full text-base inline-block hover:bg-blue-700 transition mt-6">
                    Let AI Analyze for Me
                </button>
            </div>
        </div>

        <!-- Skip Quiz Link -->
        <div id="skip-quiz-container" class="text-center mt-6">
            <button id="skip-quiz-btn" class="text-sm font-semibold text-gray-500 hover:text-blue-600 transition">
                Don't want to answer questions? Input your thoughts directly &rarr;
            </button>
        </div>

        <!-- Results/Chat Container -->
        <div id="results-container" class="w-full max-w-3xl mx-auto hidden">
            <div id="initial-result" class="text-center bg-white rounded-xl shadow-lg p-6 md:p-10">
                <!-- Initial summary will be injected here -->
            </div>

            <div id="chat-wrapper" class="hidden mt-6 bg-white rounded-xl shadow-lg p-6 md:p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">In-depth Conversation with AI Mentor</h2>
                <div id="chat-history" class="h-[50vh] overflow-y-auto pr-4 mb-4 border-b">
                    <!-- Full report and chat history will appear here -->
                </div>
                <div id="chat-input-container" class="flex items-center pt-4">
                    <input type="text" id="chat-input" placeholder="Have other questions? Enter here..." class="flex-grow border rounded-l-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <button id="send-btn" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-r-lg hover:bg-blue-700 transition">&rarr;</button>
                </div>
            </div>
        </div>

        <!-- Additional Content Section -->
        <section id="additional-content" class="w-full mt-16 mb-16">
            <div class="container mx-auto px-6">
                
                <!-- Usage Examples -->
                <div class="mb-16">
                    <h2 class="text-3xl font-bold text-center text-gray-900 mb-10">See How They Found Their Direction</h2>
                    <div class="max-w-5xl mx-auto">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <blockquote class="text-gray-600">
                                    <p>"I always thought my introverted personality didn't fit my marketing major. After talking with the AI mentor, it helped me identify the 'Data Analyst (Marketing)' role, which uses my professional knowledge without requiring too much social interaction. It's perfect for me!"</p>
                                </blockquote>
                                <p class="mt-4 font-semibold text-gray-900">- Li, a junior student</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <blockquote class="text-gray-600">
                                    <p>"After working for three years, I felt like I was just repeating myself every day and lost my passion. Through 'Career Compass', I discovered my core drivers are 'creativity' and 'autonomy'. I'm now learning to develop my own small product in my spare time, and life feels hopeful again."</p>
                                </blockquote>
                                <p class="mt-4 font-semibold text-gray-900">- Ms. Wang, a young professional</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FAQ -->
                <div class="max-w-3xl mx-auto mb-16">
                    <h2 class="text-3xl font-bold text-center text-gray-900 mb-10">Frequently Asked Questions</h2>
                    <div class="space-y-4">
                        <details class="group bg-white p-4 rounded-xl shadow-lg cursor-pointer">
                            <summary class="flex justify-between items-center font-semibold text-gray-900">
                                Is this test and analysis free?
                                <svg class="w-5 h-5 transform transition-transform group-open:rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </summary>
                            <p class="mt-3 text-gray-600">
                                Yes, it's completely free. We are committed to helping more people who are confused about their future through AI technology. Some of the models we use are provided with free quotas by platforms like OpenRouter, allowing us to pass this value on to you.
                            </p>
                        </details>
                        <details class="group bg-white p-4 rounded-xl shadow-lg cursor-pointer">
                            <summary class="flex justify-between items-center font-semibold text-gray-900">
                                Is my data and personal information secure?
                                <svg class="w-5 h-5 transform transition-transform group-open:rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </summary>
                            <p class="mt-3 text-gray-600">
                                We take your privacy very seriously. Your answers and conversations with the AI are anonymous and are only used for the current analysis and dialogue. We do not store or use them for any other purpose.
                            </p>
                        </details>
                    </div>
                </div>

                <!-- Feedback -->
                <div class="text-center">
                     <h2 class="text-3xl font-bold text-center text-gray-900 mb-4">Have Suggestions or Feedback?</h2>
                     <p class="text-gray-600 mb-6">We would love to hear your voice to help us make the product better.</p>
                     <a href="mailto:czc@jobhelp.online" class="bg-gray-900 text-white font-bold py-3 px-6 rounded-full text-base inline-block hover:bg-gray-700 transition">
                        Contact Us
                    </a>
                </div>

            </div>
        </section>
    </main>

    <!-- Turnstile container, will be managed programmatically -->
    <div id="turnstile-container"></div>

    <!-- Footer -->
    <footer class="w-full py-6 text-center bg-white/50 border-t">
        <p class="text-sm text-gray-500">&copy; 2025 Career Compass. All rights reserved.</p>
    </footer>

    <script>
        // --- SCRIPT START ---
        // This script is now aligned with the fully functional Chinese version.

        const API_URL = "/api/analyze";
        const LANG = "en";

        // --- Turnstile State Management ---
        let turnstileWidgetId = null;
        let actionQueue = [];
        let isVerificationInProgress = false;

        window.onTurnstileLoad = function () {
            if (typeof turnstile !== 'undefined') {
                turnstileWidgetId = turnstile.render('#turnstile-container', {
                    sitekey: '0x4AAAAAABhyfTjwR6RXipd_',
                    callback: function(token) {
                        isVerificationInProgress = false;
                        const action = actionQueue.shift();
                        if (action) { action(token); }
                    },
                    'expired-callback': function() {
                        isVerificationInProgress = false;
                        if (turnstileWidgetId) { turnstile.reset(turnstileWidgetId); }
                    },
                    'error-callback': function() {
                        isVerificationInProgress = false;
                        document.getElementById('initial-result').innerHTML = `<div class="text-red-500">Security verification failed. Please refresh and try again.</div>`;
                        actionQueue = [];
                    },
                    size: 'invisible',
                });
            }
        };

        function executeProtectedAction(action) {
            actionQueue.push(action);
            if (isVerificationInProgress) { return; }
            if (turnstileWidgetId !== null) {
                isVerificationInProgress = true;
                turnstile.execute(turnstileWidgetId);
            } else {
                document.getElementById('initial-result').innerHTML = `<div class="text-red-500">Verification component failed to load. Please refresh the page.</div>`;
            }
        }

        const questions = [
            // Using the new, improved questions
            {
                question: "Imagine you're at a casual party. What activity would most appeal to you?",
                options: [
                    "Having a deep, personal conversation with a close friend.",
                    "People-watching and analyzing the social dynamics.",
                    "Joining in on a lively board game or group activity.",
                    "Helping the host organize food or making sure everyone is having a good time."
                ]
            },
            {
                question: "If you had a completely free weekend, how would you ideally spend it?",
                options: [
                    "Reading a book, learning a new skill, or watching a documentary.",
                    "Creating something: writing, drawing, making music, or a DIY project.",
                    "Going for a hike, playing a sport, or doing some other outdoor physical activity.",
                    "Spending quality time with family or friends."
                ]
            },
            {
                question: "When facing a complex problem at work, what's your initial approach?",
                options: [
                    "Gathering and analyzing data to understand the root cause.",
                    "Brainstorming creative and unconventional solutions.",
                    "Organizing a team and delegating tasks to tackle it from multiple angles.",
                    "Considering the problem's impact on team members and customers."
                ]
            },
            {
                question: "What motivates you most in a career?",
                options: [
                    "Mastery of a skill and becoming an expert in your field.",
                    "The opportunity to express your creativity and innovate.",
                    "Leadership, influence, and achieving ambitious goals.",
                    "Helping others and making a positive impact on society."
                ]
            },
            {
                question: "What kind of work environment do you prefer?",
                options: [
                    "A quiet, structured environment where you can focus on your tasks.",
                    "A dynamic, flexible environment that encourages experimentation.",
                    "A competitive, results-driven environment with clear targets.",
                    "A collaborative, supportive environment focused on teamwork."
                ]
            }
        ];

        let currentQuestionIndex = 0;
        const userAnswers = [];
        const markdownConverter = new showdown.Converter({ simplifiedAutoLink: true, tables: true, strikethrough: true });

        const viewContainer = document.getElementById('view-container');
        const quizContainer = document.getElementById('quiz-container');
        const skipQuizContainer = document.getElementById('skip-quiz-container');
        const directInputContainer = document.getElementById('direct-input-container');
        const resultsContainer = document.getElementById('results-container');
        const additionalContent = document.getElementById('additional-content');
        const initialResultContainer = document.getElementById('initial-result');
        const chatWrapper = document.getElementById('chat-wrapper');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        
        function renderQuestion() {
            const cardData = questions[currentQuestionIndex];
            const card = document.createElement('div');
            card.className = 'quiz-card bg-white rounded-xl shadow-lg p-6 md:p-10 card-enter';
            
            const optionsHTML = cardData.options.map(option => `
                <div class="option border rounded-lg p-4 mb-3 cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition">
                    <span>${option}</span>
                </div>`
            ).join('');

            card.innerHTML = `
                <div class="text-right text-sm font-semibold text-gray-400 mb-4">${currentQuestionIndex + 1} / ${questions.length}</div>
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8">${cardData.question}</h2>
                <div class="options-container">${optionsHTML}</div>
            `;
            
            quizContainer.innerHTML = '';
            quizContainer.appendChild(card);
            requestAnimationFrame(() => card.classList.remove('card-enter'));
            card.querySelectorAll('.option').forEach(el => el.addEventListener('click', () => handleOptionSelect(el.querySelector('span').innerText)));
        }

        function handleOptionSelect(answer) {
            userAnswers.push({ question: questions[currentQuestionIndex].question, answer: answer });
            const card = quizContainer.querySelector('.quiz-card');
            card.classList.add('card-exit');
            
            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    renderQuestion();
                } else {
                    const prompt = createQuizPrompt(JSON.stringify(userAnswers));
                    triggerAnalysis(prompt);
                }
            }, 500);
        }

        function triggerAnalysis(prompt) {
            viewContainer.style.display = 'none';
            skipQuizContainer.style.display = 'none';
            additionalContent.style.display = 'none';
            resultsContainer.style.display = 'block';
            initialResultContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center"><div class="spinner"></div><p class="text-gray-600 mt-4">Requesting verification...</p></div>`;
            
            executeProtectedAction((token) => {
                initialResultContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center"><div class="spinner"></div><p class="text-gray-600 mt-4">Verification successful. Generating your initial analysis...</p></div>`;
                callInitialAnalysis(prompt, token);
            });
        }

        function createQuizPrompt(userChoices) {
            return `You are a top-tier AI career advisor named "Career Compass." The user has completed the questionnaire. Here are their choices:
            ---
            ${userChoices}
            ---
            Please return your analysis strictly in the following JSON format.
            Important rule: Your entire response must be a single, raw JSON object that can be parsed directly by JSON.parse(). Within JSON string values, all double quotes (") must be escaped with a backslash (\\), e.g., "He said \\"hello world\\"".
            {
              "archetype_title": "A precise, engaging archetype title, e.g., The Risk Controller",
              "archetype_summary": "A one-sentence summary that vividly captures the core traits of this archetype.",
              "job_suggestions": ["Provide the 3 best-matching career paths based on the analysis (array of strings)"],
              "full_report": "This is the complete, detailed analysis report, please use Markdown format. The report should include: 1. A deeper interpretation of the archetype. 2. A detailed analysis of their values and motivations. 3. A detailed explanation of the 3 recommended career paths. 4. An encouraging closing and a prompt for follow-up questions."
            }`;
        }

        function createDirectInputPrompt(userInput) {
            return `You are a top-tier AI career advisor named "Career Compass." A user has initiated a direct conversation. Here is their input:
            ---
            ${userInput}
            ---
            Please return your analysis strictly in the following JSON format.
            Important rule: Your entire response must be a single, raw JSON object that can be parsed directly by JSON.parse(). Within JSON string values, all double quotes (") must be escaped with a backslash (\\), e.g., "He said \\"hello world\\"".
            {
              "archetype_title": "A precise, engaging archetype title",
              "archetype_summary": "A one-sentence summary that vividly captures the user's core traits.",
              "job_suggestions": ["Provide the 3 best-matching career paths based on the analysis (array of strings)"],
              "full_report": "This is the complete, detailed analysis report, please use Markdown format. The report should include: 1. A deep interpretation of the user's self-description. 2. Uncovering potential values and motivations. 3. A detailed explanation of the 3 recommended career paths. 4. An encouraging closing and a prompt for follow-up questions."
            }`;
        }

        let fullReport = '';
        let conversationHistory = [];

        async function callInitialAnalysis(prompt, turnstileToken) {
             try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "qwen/qwen3-8b:free",
                        messages: [{ role: "user", content: prompt }],
                        stream: false,
                        turnstileToken: turnstileToken
                    }),
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API call failed: ${response.status}. ${errorBody}`);
                }

                const result = await response.json();
                const analysis = JSON.parse(result.choices[0].message.content);

                fullReport = analysis.full_report.replace(/\\"/g, '"');
                let suggestionsHTML = '';
                if (analysis.job_suggestions && analysis.job_suggestions.length > 0) {
                    suggestionsHTML = `
                        <div class="mt-8 pt-6 border-t border-gray-200">
                            <p class="text-sm font-semibold text-gray-500 mb-4">Recommended career paths for you:</p>
                            <div class="flex flex-wrap justify-center gap-3">
                                ${analysis.job_suggestions.map(job => `<span class="bg-gray-100 text-gray-800 text-sm font-medium px-4 py-2 rounded-full">${job.replace(/\\"/g, '"')}</span>`).join('')}
                            </div>
                        </div>`;
                }

                initialResultContainer.innerHTML = `
                    <h2 class="text-3xl md:text-4xl font-extrabold text-blue-600 mb-3">${analysis.archetype_title.replace(/\\"/g, '"')}</h2>
                    <p class="text-lg text-gray-700 max-w-2xl mx-auto">${analysis.archetype_summary.replace(/\\"/g, '"')}</p>
                    ${suggestionsHTML}
                    <button id="show-full-report-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full text-base inline-block hover:bg-blue-700 transition mt-10">
                        View Full Analysis & Start Chat
                    </button>
                `;

                document.getElementById('show-full-report-btn').addEventListener('click', showFullReportAndChat);

            } catch (error) {
                initialResultContainer.innerHTML = `<div class="text-red-500">Sorry, an error occurred during analysis: ${error.message}</div>`;
            }
        }
        
        function showFullReportAndChat() {
            document.getElementById('initial-result').style.display = 'none';
            chatWrapper.style.display = 'block';
            const reportHtml = markdownConverter.makeHtml(fullReport);
            chatHistory.innerHTML = `<div class="prose max-w-none p-2">${reportHtml}</div>`;
            conversationHistory = [
                { role: "user", content: "This is my questionnaire result, please begin the analysis:" + JSON.stringify(userAnswers) },
                { role: "assistant", content: fullReport }
            ];
        }

        async function callLLM(messages, turnstileToken) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "qwen/qwen3-8b:free",
                        messages: messages,
                        stream: true,
                        turnstileToken: turnstileToken
                    }),
                });

                if (!response.ok) throw new Error(`API call failed: ${response.status}. ${await response.text()}`);
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let botMessageContent = '';
                
                const botMessageContainer = document.createElement('div');
                botMessageContainer.className = "flex justify-start mb-3";
                botMessageContainer.innerHTML = `<div class="bg-gray-100 rounded-lg py-2 px-4 max-w-lg prose"></div>`;
                chatHistory.appendChild(botMessageContainer);
                const contentElement = botMessageContainer.querySelector('div');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); 
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const content = line.substring(6);
                            if (content === '[DONE]') continue;
                            try {
                                const chunk = JSON.parse(content);
                                if (chunk.choices[0].delta.content) {
                                    botMessageContent += chunk.choices[0].delta.content;
                                    contentElement.innerHTML = markdownConverter.makeHtml(botMessageContent);
                                    chatHistory.scrollTop = chatHistory.scrollHeight;
                                }
                            } catch (e) { console.error('Error parsing stream chunk:', e); }
                        }
                    }
                }
                conversationHistory.push({ role: "assistant", content: botMessageContent });
            } catch (error) {
                const errorElement = document.createElement('div');
                errorElement.className = 'text-red-500';
                errorElement.textContent = `Sorry, an error occurred: ${error.message}`;
                chatHistory.appendChild(errorElement);
            } finally {
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
                if (turnstileWidgetId) turnstile.reset(turnstileWidgetId);
            }
        }
        
        async function handleSendMessage() {
            const messageText = chatInput.value.trim();
            if (!messageText) return;

            const userMessageHTML = `<div class="flex justify-end mb-3"><div class="bg-blue-500 text-white rounded-lg py-2 px-4 max-w-lg">${messageText}</div></div>`;
            chatHistory.innerHTML += userMessageHTML;
            chatHistory.scrollTop = chatHistory.scrollHeight;
            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;

            const systemInstruction = `Rule: You are an AI career mentor named "Career Compass." Your answers must be concise (try to stay under three sentences, use lists often) and always revolve around career planning, skill improvement, job search advice, etc. If the user asks an unrelated question (e.g., "what's the weather like," "tell me a joke"), you must politely decline and guide them back to career topics.`;
            const messagesForAPI = [...conversationHistory, { role: 'system', content: systemInstruction }, { role: 'user', content: messageText }];
            
            executeProtectedAction((token) => {
                conversationHistory.push({ role: 'user', content: messageText });
                callLLM(messagesForAPI, token);
            });
        }

        function setupEventListeners() {
            document.getElementById('skip-quiz-btn').addEventListener('click', () => {
                const card = quizContainer.querySelector('.quiz-card');
                if (card) card.classList.add('card-exit');
                setTimeout(() => {
                    quizContainer.style.display = 'none';
                    directInputContainer.classList.remove('hidden');
                    directInputContainer.classList.add('card-enter');
                    requestAnimationFrame(() => directInputContainer.classList.remove('card-enter'));
                }, 500);
            });

            document.getElementById('direct-input-submit-btn').addEventListener('click', () => {
                const userInput = document.getElementById('direct-input-text').value;
                if (userInput.trim().length < 20) {
                    alert('For a more accurate analysis, please enter at least 20 characters.');
                    return;
                }
                const prompt = createDirectInputPrompt(userInput);
                triggerAnalysis(prompt);
            });

            sendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSendMessage()));
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderQuestion();
            setupEventListeners();
        });
        
    </script>
</body>
</html>
