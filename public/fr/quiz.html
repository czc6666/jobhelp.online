<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Carri√®re - Boussole de Carri√®re</title>
    <meta name="description" content="Commencez votre test de carri√®re interactif. R√©pondez √† une s√©rie de questions pour recevoir une analyse de carri√®re personnalis√©e par l'IA ou d√©crivez directement votre situation.">
    <meta name="robots" content="noindex, follow">
    <link rel="canonical" href="https://jobhelp.online/fr/quiz.html">
    <link rel="alternate" hreflang="zh" href="https://jobhelp.online/quiz.html">
    <link rel="alternate" hreflang="en" href="https://jobhelp.online/en/quiz.html">
    <link rel="alternate" hreflang="es" href="https://jobhelp.online/es/quiz.html">
    <link rel="alternate" hreflang="de" href="https://jobhelp.online/de/quiz.html">
    <link rel="alternate" hreflang="fr" href="https://jobhelp.online/fr/quiz.html">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link rel="stylesheet" href="../styles.css">
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <header class="bg-white shadow-md w-full">
        <nav class="container mx-auto px-6 py-4">
            <a href="index.html" class="text-xl font-bold text-gray-800">Boussole de Carri√®re</a>
        </nav>
    </header>

    <main id="quiz-container" class="container mx-auto p-6 flex-grow flex flex-col justify-center">
        <!-- Quiz content will be injected here -->
    </main>

    <div id="chat-container" class="container mx-auto p-6 flex-grow flex-col justify-center" style="display: none;">
        <div id="chat-box" class="flex-grow bg-white p-4 rounded-lg shadow-inner overflow-y-auto mb-4 h-96">
            <!-- Chat messages will appear here -->
        </div>
        <div class="flex">
            <input type="text" id="chat-input" class="flex-grow border rounded-l-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Posez une question sur votre rapport...">
            <button id="chat-submit" class="bg-blue-600 text-white px-4 rounded-r-lg hover:bg-blue-700 disabled:bg-blue-300">Envoyer</button>
        </div>
    </div>
    
    <footer class="bg-white mt-auto w-full">
        <div class="container mx-auto px-6 py-4 text-center text-gray-600">
            <p>&copy; 2025 Boussole de Carri√®re. Tous droits r√©serv√©s.</p>
        </div>
    </footer>

    <script>
        const quizContainer = document.getElementById('quiz-container');
        const chatContainer = document.getElementById('chat-container');
        const chatBox = document.getElementById('chat-box');
        const chatInput = document.getElementById('chat-input');
        const chatSubmit = document.getElementById('chat-submit');
        const converter = new showdown.Converter({simplifiedAutoLink: true, openLinksInNewWindow: true, strikethrough: true});
        
        let turnstileToken = null;
        let turnstileRetries = 0;
        const MAX_RETRIES = 3;

        const questions = [
            "Quelle est la chose la plus importante que vous esp√©rez obtenir de votre prochain emploi ?",
            "Quel type d'environnement de travail vous permet de vous sentir le plus √©nergique et le plus engag√© ?",
            "D√©crivez une t√¢che ou un projet qui vous a fait perdre la notion du temps.",
            "Si vous n'aviez pas √† vous soucier de l'argent, que feriez-vous de votre temps ?",
            "Comment d√©cririez-vous votre approche id√©ale de l'√©quilibre entre vie professionnelle et vie priv√©e ?"
        ];
        let currentQuestionIndex = 0;
        let answers = [];

        function renderQuestion() {
            if (currentQuestionIndex < questions.length) {
                quizContainer.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-2xl mx-auto">
                        <p class="text-2xl font-semibold mb-6">${questions[currentQuestionIndex]}</p>
                        <textarea id="answer-input" class="w-full p-2 border rounded mb-6" rows="4" placeholder="Votre r√©ponse..."></textarea>
                        <button id="next-btn" class="bg-gray-900 text-white px-6 py-3 rounded-lg font-semibold apple-button">Suivant</button>
                        <p class="text-sm text-gray-500 mt-4">${currentQuestionIndex + 1} / ${questions.length}</p>
                    </div>
                `;
                document.getElementById('next-btn').addEventListener('click', handleNext);
            } else {
                showAnalysisOptions();
            }
        }

        function handleNext() {
            const answer = document.getElementById('answer-input').value.trim();
            if (answer) {
                answers.push(`Question ${currentQuestionIndex + 1}: ${questions[currentQuestionIndex]}\nR√©ponse: ${answer}`);
                currentQuestionIndex++;
                renderQuestion();
            } else {
                alert('Veuillez fournir une r√©ponse.');
            }
        }

        function showAnalysisOptions() {
            quizContainer.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-4">Pr√™t pour votre analyse</h2>
                    <p class="text-gray-600 mb-6">Nous avons vos r√©ponses. Vous pouvez maintenant soumettre pour une analyse bas√©e sur le quiz, ou vous pouvez sauter cela et d√©crire directement votre situation professionnelle pour une analyse personnalis√©e.</p>
                    <div class="cf-turnstile" data-sitekey="0x4AAAAAAAcF3d22Nae41Y3g" data-callback="onTurnstileSuccess"></div>
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="submit-quiz" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg apple-button hover:bg-blue-700 disabled:bg-blue-300" disabled>Analyser les r√©ponses du quiz</button>
                        <button id="direct-analysis" class="bg-gray-700 text-white font-bold py-3 px-6 rounded-lg apple-button hover:bg-gray-800">Ou, d√©crire directement</button>
                    </div>
                </div>
            `;
            document.getElementById('submit-quiz').addEventListener('click', () => submitForAnalysis(answers.join('\n\n')));
            document.getElementById('direct-analysis').addEventListener('click', showDirectInput);
        }

        function showDirectInput() {
            quizContainer.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-4">D√©crivez votre situation</h2>
                    <p class="text-gray-600 mb-6">Veuillez d√©crire votre parcours professionnel, votre situation actuelle, vos doutes ou vos objectifs. Plus vous donnez de d√©tails, meilleure sera l'analyse.</p>
                    <textarea id="direct-input" class="w-full p-2 border rounded mb-6" rows="8" placeholder="Par exemple : Je suis d√©veloppeur depuis 5 ans et je me sens perdu..."></textarea>
                    <div class="cf-turnstile" data-sitekey="0x4AAAAAAAcF3d22Nae41Y3g" data-callback="onTurnstileSuccess"></div>
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="submit-direct" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg apple-button hover:bg-blue-700 disabled:bg-blue-300" disabled>Obtenir une analyse directe</button>
                    </div>
                </div>
            `;
            document.getElementById('submit-direct').addEventListener('click', () => {
                const directText = document.getElementById('direct-input').value;
                if (directText.trim()) {
                    submitForAnalysis(directText);
                } else {
                    alert('Veuillez d√©crire votre situation.');
                }
            });
            turnstile.render(quizContainer.querySelector('.cf-turnstile'));
        }

        window.onTurnstileSuccess = function(token) {
            turnstileToken = token;
            document.querySelectorAll('#submit-quiz, #submit-direct').forEach(btn => btn.disabled = false);
        };
        
        async function submitForAnalysis(promptText) {
            if (!turnstileToken && turnstileRetries < MAX_RETRIES) {
                console.log('Turnstile token not ready, retrying...');
                turnstileRetries++;
                turnstile.reset();
                setTimeout(() => submitForAnalysis(promptText), 500);
                return;
            }

            if (!turnstileToken) {
                alert('La v√©rification de s√©curit√© a √©chou√©. Veuillez recharger la page et r√©essayer.');
                return;
            }

            quizContainer.style.display = 'none';
            chatContainer.style.display = 'flex';
            appendMessage('bot', 'ü§ñ Un instant, je pr√©pare votre analyse de carri√®re personnalis√©e...');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: promptText, token: turnstileToken, lang: 'fr' })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Une erreur s'est produite lors de l'analyse.");
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botMessageElement = appendMessage('bot', '');
                let accumulatedHtml = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    accumulatedHtml += converter.makeHtml(chunk);
                    botMessageElement.innerHTML = accumulatedHtml;
                    chatBox.scrollTop = chatBox.scrollHeight;
                }

            } catch (error) {
                console.error('Fetch error:', error);
                appendMessage('bot', `D√©sol√©, une erreur est survenue : ${error.message}`);
            }
        }
        
        function appendMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${sender === 'user' ? 'user-message' : 'bot-message'}`;
            
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            contentElement.innerHTML = text; // Use innerHTML to render markdown
            
            messageElement.appendChild(contentElement);
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
            return contentElement; // Return content element to be updated by stream
        }

        async function handleChatSubmit() {
            const userText = chatInput.value.trim();
            if (!userText) return;

            appendMessage('user', userText);
            chatInput.value = '';
            chatSubmit.disabled = true;

            const fullPrompt = `Voici la conversation jusqu'√† pr√©sent:\n${chatBox.innerText}\n\nMa nouvelle question est : ${userText}`;
            
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: fullPrompt, lang: 'fr' })
                });

                if (!response.ok) throw new Error("La r√©ponse du r√©seau n'√©tait pas OK.");

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botMessageElement = appendMessage('bot', '');
                let accumulatedHtml = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    accumulatedHtml += converter.makeHtml(chunk);
                    botMessageElement.innerHTML = accumulatedHtml;
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } catch (error) {
                console.error('Chat error:', error);
                appendMessage('bot', "D√©sol√©, je n'ai pas pu traiter votre question.");
            } finally {
                chatSubmit.disabled = false;
                chatInput.focus();
            }
        }
        
        chatSubmit.addEventListener('click', handleChatSubmit);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleChatSubmit();
        });

        // Initial render
        renderQuestion();
    </script>
</body>
</html> 