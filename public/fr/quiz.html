<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commencer le Test | Boussole de Carrière</title>
    <meta name="description" content="Répondez à 5 questions soigneusement conçues pour recevoir instantanément un rapport d'analyse de personnalité de carrière approfondi généré par l'IA et commencez votre exploration de carrière.">
    <meta name="keywords" content="test de carrière, analyse de personnalité, conseiller de carrière IA, orientation professionnelle, Boussole de Carrière, quiz en ligne">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://jobhelp.online/fr/quiz.html">

    <!-- Hreflang for SEO -->
    <link rel="alternate" hreflang="zh" href="https://jobhelp.online/quiz.html">
    <link rel="alternate" hreflang="en" href="https://jobhelp.online/en/quiz.html">
    <link rel="alternate" hreflang="es" href="https://jobhelp.online/es/quiz.html">
    <link rel="alternate" hreflang="de" href="https://jobhelp.online/de/quiz.html">
    <link rel="alternate" hreflang="fr" href="https://jobhelp.online/fr/quiz.html">
    <link rel="alternate" hreflang="ja" href="https://jobhelp.online/ja/quiz.html">
    <link rel="alternate" hreflang="x-default" href="https://jobhelp.online/quiz.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jobhelp.online/fr/quiz.html">
    <meta property="og:title" content="Commencer le Test | Boussole de Carrière">
    <meta property="og:description" content="Répondez à 5 questions conçues avec soin pour obtenir instantanément un rapport d'analyse approfondie de votre personnalité professionnelle généré par l'IA.">
    <meta property="og:image" content="https://jobhelp.online/og-image.png">
    <meta property="og:site_name" content="Boussole de Carrière">
    <meta property="og:locale" content="fr_FR">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://jobhelp.online/fr/quiz.html">
    <meta name="twitter:title" content="Commencer le Test | Boussole de Carrière">
    <meta name="twitter:description" content="Répondez à 5 questions conçues avec soin pour obtenir instantanément un rapport d'analyse approfondie de votre personnalité professionnelle généré par l'IA.">
    <meta name="twitter:image" content="https://jobhelp.online/og-image.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <!-- Turnstile Script (Temporarily Disabled) -->
    <!-- <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onTurnstileLoad" async defer></script> -->
    <style>
        .quiz-card, #direct-input-container {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0) scale(1);
            opacity: 1;
            will-change: transform, opacity;
            min-height: 32rem;
        }
        .card-enter { transform: translateX(100%) scale(0.9); opacity: 0; }
        .card-exit { transform: translateX(-100%) scale(0.9); opacity: 0; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <!-- Structured Data (JSON-LD) for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [{
            "@type": "Question",
            "name": "Ce test et cette analyse sont-ils gratuits ?",
            "acceptedAnswer": { "@type": "Answer", "text": "Oui, c'est entièrement gratuit. Nous nous engageons à aider davantage de personnes confuses quant à leur avenir grâce à la technologie de l'IA. Certains des modèles que nous utilisons sont fournis avec des quotas gratuits par des plateformes comme OpenRouter, ce qui nous permet de vous transmettre cette valeur." }
        }, {
            "@type": "Question",
            "name": "Mes données et informations personnelles sont-elles en sécurité ?",
            "acceptedAnswer": { "@type": "Answer", "text": "Nous prenons votre vie privée très au sérieux. Vos réponses et conversations avec l'IA sont anonymes et ne sont utilisées que pour l'analyse et le dialogue en cours. Nous ne les stockons ni ne les utilisons à d'autres fins." }
        }]
    }
    </script>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="w-full bg-white/80 backdrop-blur-md sticky top-0 z-10 border-b border-gray-200">
        <div class="container mx-auto px-6 py-4 flex items-center justify-between">
            <a href="/fr/" class="text-xl font-bold text-gray-900">Boussole de Carrière</a>
            <a href="/fr/" class="text-sm font-semibold text-gray-600 hover:text-blue-600">&larr; Retour à l'accueil</a>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center justify-center p-4">
        <div id="view-container" class="w-full max-w-2xl mx-auto">
            <div id="quiz-container"></div>
            <div id="direct-input-container" class="hidden bg-white rounded-xl shadow-lg p-6 md:p-10">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Parlez directement au mentor IA</h2>
                <p class="text-gray-600 mb-6">Entrez vos préoccupations, vos pensées ou une présentation de vous-même ci-dessous, et l'IA générera un rapport de planification de carrière personnalisé pour vous.</p>
                <textarea id="direct-input-text" rows="8" placeholder="Ex: Je suis étudiant en marketing, mais je me sens introverti et n'aime pas socialiser. Je suis confus quant à mon avenir et je ne sais pas ce que je peux faire..." class="w-full border rounded-lg p-3 text-base focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
                <button id="direct-input-submit-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-full text-base inline-block hover:bg-blue-700 transition mt-6">Laisser l'IA analyser pour moi</button>
            </div>
        </div>
        <div id="skip-quiz-container" class="text-center mt-6">
            <button id="skip-quiz-btn" class="text-sm font-semibold text-gray-500 hover:text-blue-600 transition">Vous ne voulez pas répondre aux questions ? Entrez vos pensées directement &rarr;</button>
        </div>
        <div id="results-container" class="w-full max-w-3xl mx-auto hidden">
            <div id="initial-result" class="text-center bg-white rounded-xl shadow-lg p-6 md:p-10"></div>
            <div id="chat-wrapper" class="hidden mt-6 bg-white rounded-xl shadow-lg p-6 md:p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Conversation approfondie avec le mentor IA</h2>
                <div id="chat-history" class="h-[50vh] overflow-y-auto pr-4 mb-4 border-b"></div>
                <div id="chat-input-container" class="flex items-center pt-4">
                    <input type="text" id="chat-input" placeholder="D'autres questions ? Entrez-les ici..." class="flex-grow border rounded-l-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <button id="send-btn" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-r-lg hover:bg-blue-700 transition">&rarr;</button>
                </div>
            </div>
        </div>
        <section id="additional-content" class="w-full mt-16 mb-16">
            <div class="container mx-auto px-6">
                <div class="mb-16">
                    <h2 class="text-3xl font-bold text-center text-gray-900 mb-10">Voyez comment ils ont trouvé leur voie</h2>
                    <div class="max-w-5xl mx-auto grid md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <blockquote class="text-gray-600"><p>"J'ai toujours pensé que ma personnalité introvertie ne correspondait pas à ma majeure en marketing. Après avoir parlé avec le mentor IA, il m'a aidé à identifier le rôle d'Analyste de Données (Marketing), qui utilise mes connaissances professionnelles sans nécessiter trop d'interaction sociale. C'est parfait pour moi !"</p></blockquote>
                            <p class="mt-4 font-semibold text-gray-900">- Léo, étudiant</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <blockquote class="text-gray-600"><p>"Après trois ans de travail, j'avais l'impression de me répéter chaque jour et j'avais perdu ma passion. Grâce à 'Boussole de Carrière', j'ai découvert que mes moteurs principaux sont la 'créativité' et l''autonomie'. J'apprends maintenant à développer mon propre petit produit pendant mon temps libre, et la vie semble à nouveau pleine d'espoir."</p></blockquote>
                            <p class="mt-4 font-semibold text-gray-900">- Mme Dubois, jeune professionnelle</p>
                        </div>
                    </div>
                </div>
                <div class="max-w-3xl mx-auto mb-16">
                    <h2 class="text-3xl font-bold text-center text-gray-900 mb-10">Foire Aux Questions</h2>
                    <div class="space-y-4">
                        <details class="group bg-white p-4 rounded-xl shadow-lg cursor-pointer">
                            <summary class="flex justify-between items-center font-semibold text-gray-900">Ce test et cette analyse sont-ils gratuits ?<svg class="w-5 h-5 transform transition-transform group-open:rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></summary>
                            <p class="mt-3 text-gray-600">Oui, c'est entièrement gratuit. Nous nous engageons à aider davantage de personnes confuses quant à leur avenir grâce à la technologie de l'IA. Certains des modèles que nous utilisons sont fournis avec des quotas gratuits par des plateformes comme OpenRouter, ce qui nous permet de vous transmettre cette valeur.</p>
                        </details>
                        <details class="group bg-white p-4 rounded-xl shadow-lg cursor-pointer">
                            <summary class="flex justify-between items-center font-semibold text-gray-900">Mes données et informations personnelles sont-elles en sécurité ?<svg class="w-5 h-5 transform transition-transform group-open:rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></summary>
                            <p class="mt-3 text-gray-600">Nous prenons votre vie privée très au sérieux. Vos réponses et conversations avec l'IA sont anonymes et ne sont utilisées que pour l'analyse et le dialogue en cours. Nous ne les stockons ni ne les utilisons à d'autres fins.</p>
                        </details>
                    </div>
                </div>
                <div class="text-center">
                     <h2 class="text-3xl font-bold text-center text-gray-900 mb-4">Avez-vous des suggestions ou des commentaires ?</h2>
                     <p class="text-gray-600 mb-6">Nous serions ravis de connaître votre avis pour nous aider à améliorer le produit.</p>
                     <a href="mailto:czc@jobhelp.online" class="bg-gray-900 text-white font-bold py-3 px-6 rounded-full text-base inline-block hover:bg-gray-700 transition">Nous Contacter</a>
                </div>
            </div>
        </section>
    </main>

    <!-- <div id="turnstile-container"></div> -->
    <footer class="w-full py-6 text-center bg-white/50 border-t">
        <p class="text-sm text-gray-500">&copy; 2025 Boussole de Carrière. Tous droits réservés.</p>
    </footer>

    <script>
        // --- CONFIGURATION ---
        const API_URL = "/api/analyze";

        // --- Turnstile State Management (Disabled) ---
        /*
        let turnstileWidgetId = null;
        let actionQueue = [];
        let isVerificationInProgress = false;

        window.onTurnstileLoad = function () {
            if (typeof turnstile !== 'undefined') {
                turnstileWidgetId = turnstile.render('#turnstile-container', {
                    sitekey: '0x4AAAAAABhyfTjwR6RXipd_', // Replace with your actual site key
                    callback: function(token) {
                        isVerificationInProgress = false;
                        const action = actionQueue.shift();
                        if (action) {
                            action(token);
                        }
                    },
                    'expired-callback': () => { isVerificationInProgress = false; if (turnstileWidgetId) turnstile.reset(turnstileWidgetId); },
                    'error-callback': () => { isVerificationInProgress = false; console.error('Le défi Turnstile n\'a pas pu être rendu.'); },
                    size: 'invisible'
                });
            }
        };

        function executeProtectedAction(action) {
            if (isVerificationInProgress) {
                actionQueue.push(action);
                return;
            }
            if (turnstileWidgetId !== null) {
                isVerificationInProgress = true;
                actionQueue.push(action);
                turnstile.execute(turnstileWidgetId);
            } else {
                alert('Le composant de vérification n\'a pas pu être chargé. Veuillez actualiser et réessayer.');
            }
        }
        */

        // --- Core Application Logic (Restored) ---
        const quizContainer = document.getElementById('quiz-container');
        const skipQuizContainer = document.getElementById('skip-quiz-container');
        const directInputContainer = document.getElementById('direct-input-container');
        const resultsContainer = document.getElementById('results-container');
        const additionalContent = document.getElementById('additional-content');

        const initialResultContainer = document.getElementById('initial-result');
        const chatWrapper = document.getElementById('chat-wrapper');
        const chatHistoryContainer = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const directInputText = document.getElementById('direct-input-text');
        const directInputSubmitBtn = document.getElementById('direct-input-submit-btn');

        const markdownConverter = new showdown.Converter();
        let conversationHistory = [];
        let fullReport = '';
        
        const questions = [
            {
                question: "Quel est votre équilibre idéal entre vie professionnelle et vie privée ?",
                options: {
                    a: "Des frontières claires entre le travail et la vie privée, avec des horaires fixes et des heures supplémentaires rares.",
                    b: "Le travail est au cœur de mon but dans la vie ; je suis prêt à investir beaucoup de temps pour des récompenses futures.",
                    c: "Je préfère un horaire flexible qui me permet de me concentrer profondément et sans interruption sur mes tâches.",
                    d: "Je veux que mon travail fusionne avec ma passion ; cela ne me dérange pas de brouiller les pistes pour des tâches qui ont du sens."
                }
            },
            {
                question: "Comment percevez-vous le risque par rapport à la stabilité dans votre carrière ?",
                options: {
                    a: "Je préfère nettement la stabilité ; un salaire garanti et un emploi sûr me rassurent, même avec un plafond de revenus plus bas.",
                    b: "Je suis enthousiasmé par les opportunités à haut risque et à haute récompense et je suis prêt à accepter l'incertitude pour créer une grande richesse.",
                    c: "Ma plus grande sécurité vient de mes compétences irremplaçables ; je ne m'inquiète pas du chômage tant que mes compétences sont recherchées.",
                    d: "Je suis prêt à prendre le risque de créer ma propre entreprise si l'idée est basée sur un problème réel que j'ai vécu."
                }
            },
            {
                question: "Quelle est votre principale motivation au travail ?",
                options: {
                    a: "Gagner le respect, avoir une vie stable et contribuer au sein d'un système structuré.",
                    b: "Rechercher la richesse, la liberté et le pouvoir de contrôler ma propre vie.",
                    c: "Devenir un expert de premier plan dans mon domaine et apprécier le sentiment d'accomplissement lié à la maîtrise d'un métier complexe.",
                    d: "Résoudre un problème qui a causé une réelle souffrance pour moi ou pour d'autres et voir mon travail créer un changement positif."
                }
            },
            {
                question: "Dans quel type d'environnement préférez-vous travailler ?",
                options: {
                    a: "Dans une grande organisation bien établie avec des règles, des hiérarchies et des processus clairs.",
                    b: "Dans un environnement dynamique et rapide où je peux construire, diriger une équipe et stimuler l'activité.",
                    c: "Dans un rôle avec une grande autonomie qui me permet de me concentrer sur mes tâches professionnelles sans distraction.",
                    d: "Travailler pour moi-même ou dans une très petite équipe avec un contact direct avec les clients que je sers."
                }
            },
            {
                question: "Face à un nouveau défi, comment avez-vous tendance à le résoudre ?",
                options: {
                    a: "Je suis les procédures et les normes établies pour garantir l'équité et la cohérence.",
                    b: "Je recherche les lacunes du marché et les opportunités d'innovation, même si cela signifie sortir des sentiers battus.",
                    c: "Je décompose les problèmes techniques complexes en petites parties et je les aborde une par une.",
                    d: "Je pars d'un 'point sensible' personnel et j'utilise ma propre expérience pour construire une solution."
                }
            }
        ];

        let currentQuestionIndex = 0;
        const userAnswers = [];

        function renderQuestion() {
            const cardData = questions[currentQuestionIndex];
            
            const card = document.createElement('div');
            card.className = 'quiz-card bg-white rounded-xl shadow-lg p-6 md:p-10 card-enter';
            
            let optionsHTML = '';
            for (const key in cardData.options) {
                optionsHTML += `
                    <div class="option border rounded-lg p-4 mb-3 cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition" data-value="${key}">
                        <span class="font-semibold text-gray-500 mr-3">${key.toUpperCase()})</span>
                        <span>${cardData.options[key]}</span>
                    </div>`;
            }

            card.innerHTML = `
                <div class="text-right text-sm font-semibold text-gray-400 mb-4">${currentQuestionIndex + 1} / ${questions.length}</div>
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8">${cardData.question}</h2>
                <div class="options-container">${optionsHTML}</div>
            `;
            
            quizContainer.innerHTML = ''; 
            quizContainer.appendChild(card);

            requestAnimationFrame(() => {
                card.classList.remove('card-enter');
            });

            card.querySelectorAll('.option').forEach(optionEl => {
                optionEl.addEventListener('click', () => handleOptionSelect(optionEl.dataset.value));
            });
        }

        function handleOptionSelect(answerKey) {
            const questionData = questions[currentQuestionIndex];
            userAnswers.push({ 
                question: questionData.question, 
                answer: questionData.options[answerKey] 
            });
            
            const card = quizContainer.querySelector('.quiz-card');
            card.classList.add('card-exit');
            
            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    renderQuestion();
                } else {
                    let userChoices = "";
                    userAnswers.forEach((item, index) => {
                        userChoices += `Question ${index + 1}: ${item.question}\nMon choix: ${item.answer}\n\n`;
                    });
                    const prompt = createQuizPrompt(userChoices);
                    triggerAnalysis(prompt);
                }
            }, 500);
        }

        function triggerAnalysis(prompt) {
            document.getElementById('view-container').style.display = 'none';
            skipQuizContainer.style.display = 'none';
            additionalContent.style.display = 'none';
            resultsContainer.style.display = 'block';
            initialResultContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center">
                <div class="spinner"></div>
                <p class="text-gray-600 mt-4">Génération de votre analyse initiale...</p>
            </div>`;
            
            callInitialAnalysis(prompt);
        }

        function createQuizPrompt(userChoices) {
            return `Vous êtes un conseiller d'orientation IA de premier plan nommé "Boussole de Carrière". L'utilisateur a rempli le questionnaire. Voici ses choix :
            ---
            ${userChoices}
            ---
            Veuillez retourner votre analyse strictement au format JSON suivant.
            Règle importante : Votre réponse entière doit être un seul objet JSON brut qui peut être directement analysé par JSON.parse(). Dans les valeurs de chaîne JSON, tous les guillemets doubles (") doivent être échappés avec une barre oblique inverse (\\), par exemple, "Il a dit \\"bonjour le monde\\"".
            {
              "archetype_title": "Un titre d'archétype précis et engageant, par ex., Le Contrôleur de Risques",
              "archetype_summary": "Un résumé d'une phrase qui capture de manière vivante les traits principaux de cet archétype.",
              "job_suggestions": ["Fournissez les 3 parcours de carrière les plus pertinents sur la base de l'analyse (tableau de chaînes)"],
              "full_report": "Ceci est le rapport d'analyse complet et détaillé, veuillez utiliser le format Markdown. Le rapport doit inclure : 1. Une interprétation plus approfondie de l'archétype. 2. Une analyse détaillée de leurs valeurs et motivations. 3. Une explication détaillée des 3 parcours de carrière recommandés. 4. Une conclusion encourageante et une incitation à poser des questions de suivi."
            }`;
        }

        function createDirectInputPrompt(userInput) {
            return `Vous êtes un conseiller d'orientation IA de premier plan nommé "Boussole de Carrière". Un utilisateur a entamé une conversation directe. Voici son entrée :
            ---
            ${userInput}
            ---
            Veuillez retourner votre analyse strictement au format JSON suivant.
            Règle importante : Votre réponse entière doit être un seul objet JSON brut qui peut être directement analysé par JSON.parse(). Dans les valeurs de chaîne JSON, tous les guillemets doubles (") doivent être échappés avec une barre oblique inverse (\\), par exemple, "Il a dit \\"bonjour le monde\\"".
            {
              "archetype_title": "Un titre d'archétype précis et engageant",
              "archetype_summary": "Un résumé d'une phrase qui capture de manière vivante les traits principaux de l'utilisateur.",
              "job_suggestions": ["Fournissez les 3 parcours de carrière les plus pertinents sur la base de l'analyse (tableau de chaînes)"],
              "full_report": "Ceci est le rapport d'analyse complet et détaillé, veuillez utiliser le format Markdown. Le rapport doit inclure : 1. Une interprétation approfondie de l'autodescription de l'utilisateur. 2. La découverte de valeurs et de motivations potentielles. 3. Une explication détaillée des 3 parcours de carrière recommandés. 4. Une conclusion encourageante et une incitation à poser des questions de suivi."
            }`;
        }

        async function callInitialAnalysis(prompt) {
             try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "qwen/qwen3-8b:free",
                        messages: [{ role: "user", content: prompt }],
                        stream: false
                    }),
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`L'appel API a échoué : ${response.status}. ${errorBody}`);
                }

                const result = await response.json();
                const analysis = JSON.parse(result.choices[0].message.content);

                fullReport = analysis.full_report.replace(/\\"/g, '"');

                let suggestionsHTML = '';
                if (analysis.job_suggestions && analysis.job_suggestions.length > 0) {
                    suggestionsHTML = `
                        <div class="mt-8 pt-6 border-t border-gray-200">
                            <p class="text-sm font-semibold text-gray-500 mb-4">Pistes de carrière recommandées pour vous :</p>
                            <div class="flex flex-wrap justify-center gap-3">
                                ${analysis.job_suggestions.map(job => `<span class="bg-gray-100 text-gray-800 text-sm font-medium px-4 py-2 rounded-full">${job.replace(/\\"/g, '"')}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }

                initialResultContainer.innerHTML = `
                    <h2 class="text-3xl md:text-4xl font-extrabold text-blue-600 mb-3">${analysis.archetype_title.replace(/\\"/g, '"')}</h2>
                    <p class="text-lg text-gray-700 max-w-2xl mx-auto">${analysis.archetype_summary.replace(/\\"/g, '"')}</p>
                    ${suggestionsHTML}
                    <button id="show-full-report-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full text-base inline-block hover:bg-blue-700 transition mt-10">
                        Voir l'analyse complète et démarrer le chat
                    </button>
                `;

                document.getElementById('show-full-report-btn').addEventListener('click', showFullReportAndChat);

            } catch (error) {
                initialResultContainer.innerHTML = `<div class="text-red-500">Désolé, une erreur est survenue lors de l'analyse : ${error.message}</div>`;
            }
        }
        
        function showFullReportAndChat() {
            document.getElementById('initial-result').style.display = 'none';
            chatWrapper.style.display = 'block';

            const reportHtml = markdownConverter.makeHtml(fullReport);
            chatHistoryContainer.innerHTML = `<div class="prose max-w-none p-2">${reportHtml}</div>`;

            conversationHistory = [
                { role: "user", content: "Voici le résultat de mon questionnaire, veuillez commencer l'analyse :" + JSON.stringify(userAnswers) },
                { role: "assistant", content: fullReport }
            ];
        }

        async function callLLM(messages) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "qwen/qwen3-8b:free",
                        messages: messages,
                        stream: true,
                    }),
                });

                if (!response.ok) throw new Error(`L'appel API a échoué : ${response.status}. ${await response.text()}`);
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let botMessageContent = '';
                
                const botMessageContainer = document.createElement('div');
                botMessageContainer.className = "flex justify-start mb-3";
                botMessageContainer.innerHTML = `<div class="bg-gray-100 rounded-lg py-2 px-4 max-w-lg prose"></div>`;
                chatHistoryContainer.appendChild(botMessageContainer);
                const contentElement = botMessageContainer.querySelector('div');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); 

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const content = line.substring(6);
                            if (content === '[DONE]') continue;
                            try {
                                const chunk = JSON.parse(content);
                                if (chunk.choices[0].delta.content) {
                                    botMessageContent += chunk.choices[0].delta.content;
                                    contentElement.innerHTML = markdownConverter.makeHtml(botMessageContent);
                                    chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
                                }
                            } catch (e) { console.error('Erreur lors de l'analyse du fragment de flux :', e); }
                        }
                    }
                }

                conversationHistory.push({ role: "assistant", content: botMessageContent });

            } catch (error) {
                const errorElement = document.createElement('div');
                errorElement.className = 'text-red-500';
                errorElement.textContent = `Désolé, une erreur est survenue : ${error.message}`;
                chatHistoryContainer.appendChild(errorElement);
            } finally {
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }
        
        async function handleSendMessage() {
            const messageText = chatInput.value.trim();
            if (!messageText) return;

            const userMessageHTML = `<div class="flex justify-end mb-3"><div class="bg-blue-500 text-white rounded-lg py-2 px-4 max-w-lg">${messageText}</div></div>`;
            chatHistoryContainer.innerHTML += userMessageHTML;
            chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;

            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;

            const systemInstruction = `Règle : Vous êtes un mentor de carrière IA nommé "Boussole de Carrière". Vos réponses doivent être concises (essayez de ne pas dépasser trois phrases, utilisez souvent des listes) et doivent toujours tourner autour de la planification de carrière, de l'amélioration des compétences, des conseils pour la recherche d'emploi, etc. Si l'utilisateur pose une question sans rapport (par exemple, "quel temps fait-il ?", "raconte-moi une blague"), vous devez poliment refuser et le ramener à des sujets de carrière.`;
            const messagesForAPI = [...conversationHistory, { role: 'system', content: systemInstruction }, { role: 'user', content: messageText }];
            
            conversationHistory.push({ role: 'user', content: messageText });
            callLLM(messagesForAPI);
        }

        // --- UI Event Listeners ---
        document.getElementById('skip-quiz-btn').addEventListener('click', () => {
            quizContainer.style.display = 'none';
            directInputContainer.classList.remove('hidden');
        });

        directInputSubmitBtn.addEventListener('click', () => {
            const userInput = directInputText.value;
            if (userInput.trim().length < 10) {
                alert('Pour une analyse plus précise, veuillez saisir au moins 10 caractères.');
                return;
            }
            const prompt = createDirectInputPrompt(userInput);
            triggerAnalysis(prompt);
        });

        sendBtn.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keypress', (e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSendMessage()));

        // Initial render
        document.addEventListener('DOMContentLoaded', renderQuestion);

    </script>
</body>
</html> 