<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Test | Brújula Profesional</title>
    <meta name="description" content="Responde 5 preguntas diseñadas para obtener al instante un informe de análisis de personalidad profesional profundo generado por IA y comienza tu viaje de exploración de carrera.">
    <meta name="keywords" content="test de carrera, análisis de personalidad, asesor de carrera IA, dirección profesional, Brújula Profesional, cuestionario online">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://jobhelp.online/es/quiz.html">

    <!-- Hreflang for SEO -->
    <link rel="alternate" hreflang="zh" href="https://jobhelp.online/quiz.html">
    <link rel="alternate" hreflang="en" href="https://jobhelp.online/en/quiz.html">
    <link rel="alternate" hreflang="es" href="https://jobhelp.online/es/quiz.html">
    <link rel="alternate" hreflang="de" href="https://jobhelp.online/de/quiz.html">
    <link rel="alternate" hreflang="x-default" href="https://jobhelp.online/quiz.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jobhelp.online/es/quiz.html">
    <meta property="og:title" content="Iniciar Test | Brújula Profesional">
    <meta property="og:description" content="Responde 5 preguntas diseñadas para obtener al instante un informe de análisis de personalidad profesional profundo generado por IA.">
    <meta property="og:image" content="https://jobhelp.online/og-image.png">
    <meta property="og:site_name" content="Brújula Profesional">
    <meta property="og:locale" content="es_ES">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://jobhelp.online/es/quiz.html">
    <meta name="twitter:title" content="Iniciar Test | Brújula Profesional">
    <meta name="twitter:description" content="Responde 5 preguntas diseñadas para obtener al instante un informe de análisis de personalidad profesional profundo generado por IA.">
    <meta name="twitter:image" content="https://jobhelp.online/og-image.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <!-- Turnstile Script -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onTurnstileLoad" async defer></script>
    <style>
        .quiz-card, #direct-input-container { min-height: 32rem; }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="w-full bg-white/80 backdrop-blur-md sticky top-0 z-10 border-b border-gray-200">
        <div class="container mx-auto px-6 py-4 flex items-center justify-between">
            <a href="/es/" class="text-xl font-bold text-gray-900">Brújula Profesional</a>
            <a href="/es/" class="text-sm font-semibold text-gray-600 hover:text-blue-600">
                &larr; Volver al Inicio
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center justify-center p-4">
        <div id="view-container" class="w-full max-w-2xl mx-auto">
            <!-- Quiz Container -->
            <div id="quiz-container"></div>

            <!-- Direct Input Container (hidden by default) -->
            <div id="direct-input-container" class="hidden bg-white rounded-xl shadow-lg p-6 md:p-10">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Habla Directamente con el Mentor de IA</h2>
                <p class="text-gray-600 mb-6">Introduce tus dudas, ideas o una auto-presentación a continuación, y la IA generará un informe de planificación de carrera personalizado para ti.</p>
                <textarea id="direct-input-text" rows="8" placeholder="Ej: Soy estudiante de marketing, pero me considero introvertido y no me gusta socializar. Estoy confundido sobre mi futuro y no sé qué hacer..." class="w-full border rounded-lg p-3 text-base focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
                <button id="direct-input-submit-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-full text-base inline-block hover:bg-blue-700 transition mt-6">
                    Dejar que la IA me analice
                </button>
            </div>
        </div>

        <!-- Skip Quiz Link -->
        <div id="skip-quiz-container" class="text-center mt-6">
            <button id="skip-quiz-btn" class="text-sm font-semibold text-gray-500 hover:text-blue-600 transition">
                ¿No quieres responder? Introduce tus ideas directamente &rarr;
            </button>
        </div>

        <!-- Results/Chat Container -->
        <div id="results-container" class="w-full max-w-3xl mx-auto hidden">
            <div id="initial-result" class="text-center bg-white rounded-xl shadow-lg p-6 md:p-10"></div>
            <div id="chat-wrapper" class="hidden mt-6 bg-white rounded-xl shadow-lg p-6 md:p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Conversación Profunda con el Mentor de IA</h2>
                <div id="chat-history" class="h-[50vh] overflow-y-auto pr-4 mb-4 border-b"></div>
                <div id="chat-input-container" class="flex items-center pt-4">
                    <input type="text" id="chat-input" placeholder="¿Otras preguntas? Escribe aquí..." class="flex-grow border rounded-l-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <button id="send-btn" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-r-lg hover:bg-blue-700 transition">&rarr;</button>
                </div>
            </div>
        </div>
        
    </main>

    <!-- Turnstile container, will be managed programmatically -->
    <div id="turnstile-container"></div>

    <!-- Footer -->
    <footer class="w-full py-6 text-center bg-white/50 border-t">
        <p class="text-sm text-gray-500">&copy; 2025 Brújula Profesional. Todos los derechos reservados.</p>
    </footer>

    <script>
        const API_URL = "/api/analyze";
        const LANG = "es";
        let turnstileWidgetId = null;
        let actionQueue = [];
        let isVerificationInProgress = false;

        window.onTurnstileLoad = function () {
            if (typeof turnstile !== 'undefined') {
                turnstileWidgetId = turnstile.render('#turnstile-container', {
                    sitekey: '0x4AAAAAABhyfTjwR6RXipd_', 
                    callback: function(token) {
                        isVerificationInProgress = false;
                        const action = actionQueue.shift();
                        if (action) { action(token); }
                    },
                    'expired-callback': function() {
                        isVerificationInProgress = false;
                        if (turnstileWidgetId) { turnstile.reset(turnstileWidgetId); }
                    },
                    'error-callback': function() {
                        isVerificationInProgress = false;
                        console.error('Turnstile verification failed.');
                        alert('La verificación de seguridad ha fallado. Por favor, actualiza la página e inténtalo de nuevo.');
                    },
                    size: 'invisible'
                });
            }
        };

        function withTurnstileVerification(action) {
            if (isVerificationInProgress) { return; }
            actionQueue.push(action);
            isVerificationInProgress = true;
            if (turnstileWidgetId) { turnstile.execute(turnstileWidgetId); }
        }

        const questions = [
            {
                question: "Imagina que estás en una fiesta informal. ¿Qué actividad te atraería más?",
                options: [
                    "Tener una conversación profunda y personal con un amigo cercano.",
                    "Observar a la gente y analizar las dinámicas sociales.",
                    "Participar en un juego de mesa animado o una actividad de grupo.",
                    "Ayudar al anfitrión a organizar la comida o asegurarse de que todos se diviertan."
                ]
            },
            {
                question: "Si tuvieras un fin de semana completamente libre, ¿cómo lo pasarías idealmente?",
                options: [
                    "Leyendo un libro, aprendiendo una nueva habilidad o viendo un documental.",
                    "Creando algo: escribir, dibujar, componer música o un proyecto de bricolaje.",
                    "Haciendo senderismo, practicando un deporte o realizando alguna otra actividad física al aire libre.",
                    "Pasando tiempo de calidad con la familia o los amigos."
                ]
            },
            {
                question: "Al enfrentarte a un problema complejo en el trabajo, ¿cuál es tu enfoque inicial?",
                options: [
                    "Recopilar y analizar datos para entender la causa raíz.",
                    "Hacer una lluvia de ideas de soluciones creativas y poco convencionales.",
                    "Organizar un equipo y delegar tareas para abordarlo desde múltiples ángulos.",
                    "Considerar el impacto del problema en los miembros del equipo y los clientes."
                ]
            },
            {
                question: "¿Qué te motiva más en una carrera?",
                options: [
                    "El dominio de una habilidad y convertirte en un experto en tu campo.",
                    "La oportunidad de expresar tu creatividad e innovar.",
                    "El liderazgo, la influencia y el logro de metas ambiciosas.",
                    "Ayudar a otros y tener un impacto positivo en la sociedad."
                ]
            },
            {
                question: "¿Qué tipo de ambiente de trabajo prefieres?",
                options: [
                    "Un entorno tranquilo y estructurado donde puedas concentrarte en tus tareas.",
                    "Un entorno dinámico y flexible que fomente la experimentación.",
                    "Un entorno competitivo y orientado a resultados con objetivos claros.",
                    "Un entorno colaborativo y de apoyo centrado en el trabajo en equipo."
                ]
            }
        ];

        let currentQuestionIndex = 0;
        const userAnswers = [];
        const converter = new showdown.Converter({
            simplifiedAutoLink: true,
            strikethrough: true,
            tables: true
        });

        document.addEventListener("DOMContentLoaded", () => {
            renderQuestion(currentQuestionIndex);
            document.getElementById('skip-quiz-btn').addEventListener('click', showDirectInput);
            document.getElementById('direct-input-submit-btn').addEventListener('click', handleDirectInputSubmit);
        });

        function renderQuestion(index) {
            const quizContainer = document.getElementById('quiz-container');
            const questionData = questions[index];
            const card = document.createElement('div');
            card.className = 'quiz-card bg-white rounded-xl shadow-lg p-6 md:p-10 card-enter';
            card.innerHTML = `
                <div class="text-right text-sm text-gray-500 mb-4">Pregunta ${index + 1} / ${questions.length}</div>
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">${questionData.question}</h2>
                <div class="space-y-4">
                    ${questionData.options.map((option, i) => `
                        <button data-answer="${i}" class="w-full text-left bg-gray-100 hover:bg-blue-100 border border-gray-200 text-gray-800 font-semibold py-3 px-5 rounded-lg transition">
                            ${option}
                        </button>
                    `).join('')}
                </div>`;

            quizContainer.innerHTML = ''; // Clear previous card
            quizContainer.appendChild(card);

            // Add event listeners to new buttons
            card.querySelectorAll('button[data-answer]').forEach(button => {
                button.addEventListener('click', handleAnswer);
            });
            
            // Trigger animation
            setTimeout(() => card.classList.remove('card-enter'), 10);
        }

        function handleAnswer(event) {
            userAnswers.push(event.target.innerText);
            const card = document.querySelector('.quiz-card');
            
            card.classList.add('card-exit');
            card.addEventListener('transitionend', () => {
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    renderQuestion(currentQuestionIndex);
                } else {
                    startAnalysis(userAnswers);
                }
            }, { once: true });
        }

        function showDirectInput() {
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('skip-quiz-container').classList.add('hidden');
            const directInputContainer = document.getElementById('direct-input-container');
            directInputContainer.classList.remove('hidden');
        }

        function handleDirectInputSubmit() {
            const text = document.getElementById('direct-input-text').value.trim();
            if (text.length < 20) {
                alert("Para un análisis más profundo, por favor describe tu situación con más detalle (al menos 20 caracteres).");
                return;
            }
            startAnalysis(text);
        }

        function startAnalysis(data) {
            // Hide quiz/input view and show results container
            document.getElementById('view-container').classList.add('hidden');
            document.getElementById('skip-quiz-container').classList.add('hidden');
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.classList.remove('hidden');

            const initialResultDiv = document.getElementById('initial-result');
            initialResultDiv.innerHTML = `
                <div class="spinner mx-auto mb-4"></div>
                <h2 class="text-2xl font-bold text-gray-800">Tu mentor de IA está pensando...</h2>
                <p class="text-gray-600 mt-2">Analizando tus respuestas y generando tu informe de personalidad profesional. Esto puede tardar unos 15 segundos.</p>`;
            
            withTurnstileVerification((token) => {
                fetchAnalysis(data, token, true);
            });
        }
        
        let fullReport = "";

        function fetchAnalysis(data, token, isInitialAnalysis) {
            const prompt = isInitialAnalysis ? 
                (Array.isArray(data) ? `Aquí están mis respuestas al cuestionario: ${data.join(', ')}` : data) :
                `Contexto de la conversación anterior: "${fullReport}"\n\nMi nueva pregunta: "${data}"`;

            let accumulatedContent = "";
            
            fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, lang: LANG, turnstileToken: token })
            })
            .then(response => {
                if (!response.body) throw new Error('ReadableStream not available.');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                const targetDiv = isInitialAnalysis ? document.getElementById('initial-result') : null;
                const chatHistoryDiv = isInitialAnalysis ? null : document.getElementById('chat-history');
                let aiMessageContainer;

                if (chatHistoryDiv) {
                    aiMessageContainer = document.createElement('div');
                    aiMessageContainer.className = 'mb-4';
                    aiMessageContainer.innerHTML = '<div class="font-bold text-gray-800 mb-1">Mentor de IA</div><div class="bg-gray-100 p-3 rounded-lg"></div>';
                    chatHistoryDiv.appendChild(aiMessageContainer);
                }

                function push() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            if (isInitialAnalysis) {
                                fullReport = accumulatedContent; // Store the full initial report
                                showChatInterface();
                            } else {
                                fullReport += `\n\nPregunta del usuario: ${data}\nRespuesta de la IA: ${accumulatedContent}`; // Append follow-up to context
                            }
                            enableChatInput();
                            return;
                        }
                        accumulatedContent += decoder.decode(value, { stream: true });
                        const htmlContent = converter.makeHtml(accumulatedContent);
                        
                        if (targetDiv) {
                            targetDiv.innerHTML = htmlContent;
                        } else if (aiMessageContainer) {
                            aiMessageContainer.querySelector('.bg-gray-100').innerHTML = htmlContent;
                            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
                        }

                        push();
                    }).catch(error => {
                        console.error('Streaming error:', error);
                        const errorMsg = "<p class='text-red-500'>Lo sentimos, ocurrió un error al comunicarse con la IA. Por favor, inténtalo de nuevo más tarde.</p>";
                        if (targetDiv) targetDiv.innerHTML = errorMsg;
                        if (aiMessageContainer) aiMessageContainer.innerHTML = errorMsg;
                        enableChatInput();
                    });
                }
                push();
            })
            .catch(err => {
                console.error('Fetch error:', err);
                const errorMsg = "<p class='text-red-500'>Lo sentimos, ocurrió un error de red. Por favor, revisa tu conexión e inténtalo de nuevo.</p>";
                if (isInitialAnalysis) {
                    document.getElementById('initial-result').innerHTML = errorMsg;
                }
                 enableChatInput();
            });
        }

        function showChatInterface() {
            document.getElementById('chat-history').innerHTML = `
                <div class="mb-4">
                    <div class="font-bold text-gray-800 mb-1">Informe Completo de la IA</div>
                    <div class="bg-gray-100 p-3 rounded-lg">${converter.makeHtml(fullReport)}</div>
                </div>`;
            document.getElementById('chat-wrapper').classList.remove('hidden');
            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('send-btn').click();
                }
            });
            document.getElementById('send-btn').addEventListener('click', handleSendMessage);
            enableChatInput();
        }

        function handleSendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            disableChatInput();
            
            const chatHistory = document.getElementById('chat-history');
            chatHistory.innerHTML += `
                <div class="mb-4 text-right">
                    <div class="font-bold text-blue-600 mb-1">Tú</div>
                    <div class="bg-blue-100 inline-block p-3 rounded-lg">${message}</div>
                </div>`;
            chatHistory.scrollTop = chatHistory.scrollHeight;

            input.value = '';

            withTurnstileVerification((token) => {
                fetchAnalysis(message, token, false);
            });
        }
        
        function disableChatInput() {
            document.getElementById('chat-input').disabled = true;
            document.getElementById('send-btn').disabled = true;
            document.getElementById('send-btn').innerHTML = '<div class="spinner mx-auto" style="width: 24px; height: 24px; border-width: 3px;"></div>';
        }

        function enableChatInput() {
            document.getElementById('chat-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('send-btn').innerHTML = '&rarr;';
        }

    </script>
</body>
</html> 