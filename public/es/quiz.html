<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Test | Brújula Profesional</title>
    <meta name="description" content="Responde 5 preguntas diseñadas para obtener al instante un informe de análisis de personalidad profesional profundo generado por IA y comienza tu viaje de exploración de carrera.">
    <meta name="keywords" content="test de carrera, análisis de personalidad, asesor de carrera IA, dirección profesional, Brújula Profesional, cuestionario online">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://jobhelp.online/es/quiz.html">

    <!-- Hreflang for SEO -->
    <link rel="alternate" hreflang="zh" href="https://jobhelp.online/quiz.html">
    <link rel="alternate" hreflang="en" href="https://jobhelp.online/en/quiz.html">
    <link rel="alternate" hreflang="es" href="https://jobhelp.online/es/quiz.html">
    <link rel="alternate" hreflang="de" href="https://jobhelp.online/de/quiz.html">
    <link rel="alternate" hreflang="x-default" href="https://jobhelp.online/quiz.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jobhelp.online/es/quiz.html">
    <meta property="og:title" content="Iniciar Test | Brújula Profesional">
    <meta property="og:description" content="Responde 5 preguntas diseñadas para obtener al instante un informe de análisis de personalidad profesional profundo generado por IA.">
    <meta property="og:image" content="https://jobhelp.online/og-image.png">
    <meta property="og:site_name" content="Brújula Profesional">
    <meta property="og:locale" content="es_ES">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://jobhelp.online/es/quiz.html">
    <meta name="twitter:title" content="Iniciar Test | Brújula Profesional">
    <meta name="twitter:description" content="Responde 5 preguntas diseñadas para obtener al instante un informe de análisis de personalidad profesional profundo generado por IA.">
    <meta name="twitter:image" content="https://jobhelp.online/og-image.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <!-- Turnstile Script -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onTurnstileLoad" async defer></script>
    <style>
        .quiz-card, #direct-input-container { min-height: 32rem; }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="w-full bg-white/80 backdrop-blur-md sticky top-0 z-10 border-b border-gray-200">
        <div class="container mx-auto px-6 py-4 flex items-center justify-between">
            <a href="/es/" class="text-xl font-bold text-gray-900">Brújula Profesional</a>
            <a href="/es/" class="text-sm font-semibold text-gray-600 hover:text-blue-600">
                &larr; Volver al Inicio
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center justify-center p-4">
        <div id="view-container" class="w-full max-w-2xl mx-auto">
            <!-- Quiz Container -->
            <div id="quiz-container"></div>

            <!-- Direct Input Container (hidden by default) -->
            <div id="direct-input-container" class="hidden bg-white rounded-xl shadow-lg p-6 md:p-10">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Habla Directamente con el Mentor de IA</h2>
                <p class="text-gray-600 mb-6">Introduce tus dudas, ideas o una auto-presentación a continuación, y la IA generará un informe de planificación de carrera personalizado para ti.</p>
                <textarea id="direct-input-text" rows="8" placeholder="Ej: Soy estudiante de marketing, pero me considero introvertido y no me gusta socializar. Estoy confundido sobre mi futuro y no sé qué hacer..." class="w-full border rounded-lg p-3 text-base focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
                <button id="direct-input-submit-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-full text-base inline-block hover:bg-blue-700 transition mt-6">
                    Dejar que la IA me analice
                </button>
            </div>
        </div>

        <!-- Skip Quiz Link -->
        <div id="skip-quiz-container" class="text-center mt-6">
            <button id="skip-quiz-btn" class="text-sm font-semibold text-gray-500 hover:text-blue-600 transition">
                ¿No quieres responder? Introduce tus ideas directamente &rarr;
            </button>
        </div>

        <!-- Results/Chat Container -->
        <div id="results-container" class="w-full max-w-3xl mx-auto hidden">
            <div id="initial-result" class="text-center bg-white rounded-xl shadow-lg p-6 md:p-10"></div>
            <div id="chat-wrapper" class="hidden mt-6 bg-white rounded-xl shadow-lg p-6 md:p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Conversación Profunda con el Mentor de IA</h2>
                <div id="chat-history" class="h-[50vh] overflow-y-auto pr-4 mb-4 border-b"></div>
                <div id="chat-input-container" class="flex items-center pt-4">
                    <input type="text" id="chat-input" placeholder="¿Otras preguntas? Escribe aquí..." class="flex-grow border rounded-l-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <button id="send-btn" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-r-lg hover:bg-blue-700 transition">&rarr;</button>
                </div>
            </div>
        </div>
        
    </main>

    <!-- Turnstile container, will be managed programmatically -->
    <div id="turnstile-container"></div>

    <!-- Footer -->
    <footer class="w-full py-6 text-center bg-white/50 border-t">
        <p class="text-sm text-gray-500">&copy; 2025 Brújula Profesional. Todos los derechos reservados.</p>
    </footer>

    <script>
        // --- SCRIPT START (Aligned with the functional Chinese version) ---
        const API_URL = "/api/analyze";
        const LANG = "es";

        let turnstileWidgetId = null;
        let actionQueue = [];
        let isVerificationInProgress = false;

        window.onTurnstileLoad = function () {
            if (typeof turnstile !== 'undefined') {
                turnstileWidgetId = turnstile.render('#turnstile-container', {
                    sitekey: '0x4AAAAAABhyfTjwR6RXipd_',
                    callback: function(token) {
                        isVerificationInProgress = false;
                        const action = actionQueue.shift();
                        if (action) { action(token); }
                    },
                    'expired-callback': function() {
                        isVerificationInProgress = false;
                        if (turnstileWidgetId) { turnstile.reset(turnstileWidgetId); }
                    },
                    'error-callback': function() {
                        isVerificationInProgress = false;
                        document.getElementById('initial-result').innerHTML = `<div class="text-red-500">La verificación de seguridad ha fallado. Por favor, actualiza y vuelve a intentarlo.</div>`;
                        actionQueue = [];
                    },
                    size: 'invisible',
                });
            }
        };

        function executeProtectedAction(action) {
            actionQueue.push(action);
            if (isVerificationInProgress) { return; }
            if (turnstileWidgetId !== null) {
                isVerificationInProgress = true;
                turnstile.execute(turnstileWidgetId);
            } else {
                document.getElementById('initial-result').innerHTML = `<div class="text-red-500">El componente de verificación no se pudo cargar. Por favor, actualiza la página.</div>`;
            }
        }

        const questions = [
            {
                question: "Imagina que estás en una fiesta informal. ¿Qué actividad te atraería más?",
                options: [
                    "Tener una conversación profunda y personal con un amigo cercano.",
                    "Observar a la gente y analizar las dinámicas sociales.",
                    "Participar en un juego de mesa animado o una actividad de grupo.",
                    "Ayudar al anfitrión a organizar la comida o asegurarse de que todos se diviertan."
                ]
            },
            {
                question: "Si tuvieras un fin de semana completamente libre, ¿cómo lo pasarías idealmente?",
                options: [
                    "Leyendo un libro, aprendiendo una nueva habilidad o viendo un documental.",
                    "Creando algo: escribir, dibujar, componer música o un proyecto de bricolaje.",
                    "Haciendo senderismo, practicando un deporte o realizando alguna otra actividad física al aire libre.",
                    "Pasando tiempo de calidad con la familia o los amigos."
                ]
            },
            {
                question: "Al enfrentarte a un problema complejo en el trabajo, ¿cuál es tu enfoque inicial?",
                options: [
                    "Recopilar y analizar datos para entender la causa raíz.",
                    "Hacer una lluvia de ideas de soluciones creativas y poco convencionales.",
                    "Organizar un equipo y delegar tareas para abordarlo desde múltiples ángulos.",
                    "Considerar el impacto del problema en los miembros del equipo y los clientes."
                ]
            },
            {
                question: "¿Qué te motiva más en una carrera?",
                options: [
                    "El dominio de una habilidad y convertirte en un experto en tu campo.",
                    "La oportunidad de expresar tu creatividad e innovar.",
                    "El liderazgo, la influencia y el logro de metas ambiciosas.",
                    "Ayudar a otros y tener un impacto positivo en la sociedad."
                ]
            },
            {
                question: "¿Qué tipo de ambiente de trabajo prefieres?",
                options: [
                    "Un entorno tranquilo y estructurado donde puedas concentrarte en tus tareas.",
                    "Un entorno dinámico y flexible que fomente la experimentación.",
                    "Un entorno competitivo y orientado a resultados con objetivos claros.",
                    "Un entorno colaborativo y de apoyo centrado en el trabajo en equipo."
                ]
            }
        ];

        let currentQuestionIndex = 0;
        const userAnswers = [];
        const markdownConverter = new showdown.Converter({ simplifiedAutoLink: true, tables: true, strikethrough: true });

        const viewContainer = document.getElementById('view-container');
        const quizContainer = document.getElementById('quiz-container');
        const skipQuizContainer = document.getElementById('skip-quiz-container');
        const directInputContainer = document.getElementById('direct-input-container');
        const resultsContainer = document.getElementById('results-container');
        const additionalContent = document.getElementById('additional-content');
        const initialResultContainer = document.getElementById('initial-result');
        const chatWrapper = document.getElementById('chat-wrapper');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        
        function renderQuestion() {
            const cardData = questions[currentQuestionIndex];
            const card = document.createElement('div');
            card.className = 'quiz-card bg-white rounded-xl shadow-lg p-6 md:p-10 card-enter';
            
            const optionsHTML = cardData.options.map(option => `
                <div class="option border rounded-lg p-4 mb-3 cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition">
                    <span>${option}</span>
                </div>`
            ).join('');

            card.innerHTML = `
                <div class="text-right text-sm font-semibold text-gray-400 mb-4">${currentQuestionIndex + 1} / ${questions.length}</div>
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8">${cardData.question}</h2>
                <div class="options-container">${optionsHTML}</div>
            `;
            
            quizContainer.innerHTML = '';
            quizContainer.appendChild(card);
            requestAnimationFrame(() => card.classList.remove('card-enter'));
            card.querySelectorAll('.option').forEach(el => el.addEventListener('click', () => handleOptionSelect(el.querySelector('span').innerText)));
        }

        function handleOptionSelect(answer) {
            userAnswers.push({ question: questions[currentQuestionIndex].question, answer: answer });
            const card = quizContainer.querySelector('.quiz-card');
            card.classList.add('card-exit');
            
            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    renderQuestion();
                } else {
                    const prompt = createQuizPrompt(JSON.stringify(userAnswers));
                    triggerAnalysis(prompt);
                }
            }, 500);
        }

        function triggerAnalysis(prompt) {
            viewContainer.style.display = 'none';
            skipQuizContainer.style.display = 'none';
            additionalContent.style.display = 'none';
            resultsContainer.style.display = 'block';
            initialResultContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center"><div class="spinner"></div><p class="text-gray-600 mt-4">Solicitando verificación...</p></div>`;
            
            executeProtectedAction((token) => {
                initialResultContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center"><div class="spinner"></div><p class="text-gray-600 mt-4">Verificación exitosa. Generando su análisis inicial...</p></div>`;
                callInitialAnalysis(prompt, token);
            });
        }

        function createQuizPrompt(userChoices) {
            return `Eres un asesor de carrera de IA de primer nivel llamado "Brújula Profesional". El usuario ha completado el cuestionario. Aquí están sus elecciones:
            ---
            ${userChoices}
            ---
            Por favor, devuelve tu análisis estrictamente en el siguiente formato JSON.
            Regla importante: Tu respuesta completa debe ser un único objeto JSON crudo que pueda ser analizado directamente por JSON.parse(). Dentro de los valores de cadena de JSON, todas las comillas dobles (") deben escaparse con una barra invertida (\\), ej., "Él dijo \\"hola mundo\\"".
            {
              "archetype_title": "Un título de arquetipo preciso y atractivo, ej., El Controlador de Riesgos",
              "archetype_summary": "Un resumen de una frase que capture vívidamente los rasgos centrales de este arquetipo.",
              "job_suggestions": ["Proporciona las 3 trayectorias profesionales que mejor coincidan según el análisis (array de strings)"],
              "full_report": "Este es el informe de análisis completo y detallado, por favor usa el formato Markdown. El informe debe incluir: 1. Una interpretación más profunda del arquetipo. 2. Un análisis detallado de sus valores y motivaciones. 3. Una explicación detallada de las 3 trayectorias profesionales recomendadas. 4. Un cierre alentador y una pregunta para seguimiento."
            }`;
        }

        function createDirectInputPrompt(userInput) {
            return `Eres un asesor de carrera de IA de primer nivel llamado "Brújula Profesional". Un usuario ha iniciado una conversación directa. Aquí está su entrada:
            ---
            ${userInput}
            ---
            Por favor, devuelve tu análisis estrictamente en el siguiente formato JSON.
            Regla importante: Tu respuesta completa debe ser un único objeto JSON crudo que pueda ser analizado directamente por JSON.parse(). Dentro de los valores de cadena de JSON, todas las comillas dobles (") deben escaparse con una barra invertida (\\), ej., "Él dijo \\"hola mundo\\"".
            {
              "archetype_title": "Un título de arquetipo preciso y atractivo",
              "archetype_summary": "Un resumen de una frase que capture vívidamente los rasgos centrales del usuario.",
              "job_suggestions": ["Proporciona las 3 trayectorias profesionales que mejor coincidan según el análisis (array de strings)"],
              "full_report": "Este es el informe de análisis completo y detallado, por favor usa el formato Markdown. El informe debe incluir: 1. Una interpretación profunda de la autodescripción del usuario. 2. Descubrir valores y motivaciones potenciales. 3. Una explicación detallada de las 3 trayectorias profesionales recomendadas. 4. Un cierre alentador y una pregunta para seguimiento."
            }`;
        }

        let fullReport = '';
        let conversationHistory = [];

        async function callInitialAnalysis(prompt, turnstileToken) {
             try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "qwen/qwen3-8b:free",
                        messages: [{ role: "user", content: prompt }],
                        stream: false,
                        turnstileToken: turnstileToken
                    }),
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`La llamada a la API falló: ${response.status}. ${errorBody}`);
                }

                const result = await response.json();
                const analysis = JSON.parse(result.choices[0].message.content);

                fullReport = analysis.full_report.replace(/\\"/g, '"');
                let suggestionsHTML = '';
                if (analysis.job_suggestions && analysis.job_suggestions.length > 0) {
                    suggestionsHTML = `
                        <div class="mt-8 pt-6 border-t border-gray-200">
                            <p class="text-sm font-semibold text-gray-500 mb-4">Rutas profesionales recomendadas para ti:</p>
                            <div class="flex flex-wrap justify-center gap-3">
                                ${analysis.job_suggestions.map(job => `<span class="bg-gray-100 text-gray-800 text-sm font-medium px-4 py-2 rounded-full">${job.replace(/\\"/g, '"')}</span>`).join('')}
                            </div>
                        </div>`;
                }

                initialResultContainer.innerHTML = `
                    <h2 class="text-3xl md:text-4xl font-extrabold text-blue-600 mb-3">${analysis.archetype_title.replace(/\\"/g, '"')}</h2>
                    <p class="text-lg text-gray-700 max-w-2xl mx-auto">${analysis.archetype_summary.replace(/\\"/g, '"')}</p>
                    ${suggestionsHTML}
                    <button id="show-full-report-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full text-base inline-block hover:bg-blue-700 transition mt-10">
                        Ver Análisis Completo y Iniciar Chat
                    </button>
                `;

                document.getElementById('show-full-report-btn').addEventListener('click', showFullReportAndChat);

            } catch (error) {
                initialResultContainer.innerHTML = `<div class="text-red-500">Lo sentimos, ocurrió un error durante el análisis: ${error.message}</div>`;
            }
        }
        
        function showFullReportAndChat() {
            document.getElementById('initial-result').style.display = 'none';
            chatWrapper.style.display = 'block';
            const reportHtml = markdownConverter.makeHtml(fullReport);
            chatHistory.innerHTML = `<div class="prose max-w-none p-2">${reportHtml}</div>`;
            conversationHistory = [
                { role: "user", content: "Este es el resultado de mi cuestionario, por favor comienza el análisis:" + JSON.stringify(userAnswers) },
                { role: "assistant", content: fullReport }
            ];
        }

        async function callLLM(messages, turnstileToken) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "qwen/qwen3-8b:free",
                        messages: messages,
                        stream: true,
                        turnstileToken: turnstileToken
                    }),
                });

                if (!response.ok) throw new Error(`La llamada a la API falló: ${response.status}. ${await response.text()}`);
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let botMessageContent = '';
                
                const botMessageContainer = document.createElement('div');
                botMessageContainer.className = "flex justify-start mb-3";
                botMessageContainer.innerHTML = `<div class="bg-gray-100 rounded-lg py-2 px-4 max-w-lg prose"></div>`;
                chatHistory.appendChild(botMessageContainer);
                const contentElement = botMessageContainer.querySelector('div');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); 
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const content = line.substring(6);
                            if (content === '[DONE]') continue;
                            try {
                                const chunk = JSON.parse(content);
                                if (chunk.choices[0].delta.content) {
                                    botMessageContent += chunk.choices[0].delta.content;
                                    contentElement.innerHTML = markdownConverter.makeHtml(botMessageContent);
                                    chatHistory.scrollTop = chatHistory.scrollHeight;
                                }
                            } catch (e) { console.error('Error al analizar el fragmento del stream:', e); }
                        }
                    }
                }
                conversationHistory.push({ role: "assistant", content: botMessageContent });
            } catch (error) {
                const errorElement = document.createElement('div');
                errorElement.className = 'text-red-500';
                errorElement.textContent = `Lo sentimos, ocurrió un error: ${error.message}`;
                chatHistory.appendChild(errorElement);
            } finally {
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
                if (turnstileWidgetId) turnstile.reset(turnstileWidgetId);
            }
        }
        
        async function handleSendMessage() {
            const messageText = chatInput.value.trim();
            if (!messageText) return;

            const userMessageHTML = `<div class="flex justify-end mb-3"><div class="bg-blue-500 text-white rounded-lg py-2 px-4 max-w-lg">${messageText}</div></div>`;
            chatHistory.innerHTML += userMessageHTML;
            chatHistory.scrollTop = chatHistory.scrollHeight;
            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;

            const systemInstruction = `Regla: Eres un mentor de carrera de IA llamado "Brújula Profesional". Tus respuestas deben ser concisas (intenta no pasar de tres frases, usa listas a menudo) y siempre deben girar en torno a la planificación de carrera, mejora de habilidades, consejos para la búsqueda de empleo, etc. Si el usuario hace una pregunta no relacionada (ej., "¿qué tiempo hace?", "cuéntame un chiste"), debes negarte cortésmente y guiarlo de vuelta a temas de carrera.`;
            const messagesForAPI = [...conversationHistory, { role: 'system', content: systemInstruction }, { role: 'user', content: messageText }];
            
            executeProtectedAction((token) => {
                conversationHistory.push({ role: 'user', content: messageText });
                callLLM(messagesForAPI, token);
            });
        }

        function setupEventListeners() {
            document.getElementById('skip-quiz-btn').addEventListener('click', () => {
                const card = quizContainer.querySelector('.quiz-card');
                if (card) card.classList.add('card-exit');
                setTimeout(() => {
                    quizContainer.style.display = 'none';
                    directInputContainer.classList.remove('hidden');
                    directInputContainer.classList.add('card-enter');
                    requestAnimationFrame(() => directInputContainer.classList.remove('card-enter'));
                }, 500);
            });

            document.getElementById('direct-input-submit-btn').addEventListener('click', () => {
                const userInput = document.getElementById('direct-input-text').value;
                if (userInput.trim().length < 20) {
                    alert('Para un análisis más preciso, por favor introduce al menos 20 caracteres.');
                    return;
                }
                const prompt = createDirectInputPrompt(userInput);
                triggerAnalysis(prompt);
            });

            sendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSendMessage()));
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderQuestion();
            setupEventListeners();
        });
        
    </script>
</body>
</html>
